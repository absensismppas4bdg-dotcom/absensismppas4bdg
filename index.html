<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Absensi - SMP Pasundan 4 Bandung</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <!-- SheetJS: export to .xlsx -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 50%, #1e3a5f 100%); }
    .card-shadow { box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
    .btn-primary { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .btn-primary:hover { background: linear-gradient(135deg, #d97706 0%, #b45309 100%); }
    .sidebar-item:hover { background: rgba(255,255,255,0.1); }
    .sidebar-item.active { background: rgba(245,158,11,0.3); border-left: 4px solid #f59e0b; }
    .table-row:hover { background: rgba(245,158,11,0.05); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade { animation: fadeIn 0.3s ease-out; }
    .toast { position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 8px; color: white; z-index: 9999; animation: fadeIn 0.3s ease-out; }
    .toast-success { background: #10b981; }
    .toast-error { background: #ef4444; }
    .modal-overlay { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
    .row-filled { background: rgba(16, 185, 129, 0.05); }
  </style>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#1e3a5f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="SMP Pasundan 4">
  <link rel="apple-touch-icon" href="/logosmppas4.jpg">
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-gray-100">
  <div id="app" class="h-full"></div>
  <script>
    let allData = [];
    let currentUser = null;
    let currentView = 'login';
    let config = {};
    let isLoading = false;
    // Student dashboard filters
    let studentDashboardPeriod = 'week'; // 'day' | 'week' | 'month'
    let studentDashboardDate = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
    // mobile-aware: default to compact on small screens
    let studentDashboardView = (window.innerWidth < 768) ? 'compact' : 'detailed'; // 'detailed' | 'compact' | 'chart'
    let studentShowDetails = false; // mobile toggle to show the detailed sections
    let isMobile = window.innerWidth < 768;
    window.addEventListener('resize', () => {
      const wasMobile = isMobile;
      isMobile = window.innerWidth < 768;
      if (isMobile && !wasMobile) {
        studentDashboardView = 'compact';
      }
    });

    // Student dashboard state object (used by renderStudentDashboard)
    let studentDashboard = {
      period: studentDashboardPeriod,
      date: studentDashboardDate,
      view: studentDashboardView
    };

    // Homeroom (Wali Kelas) dashboard filters
    let homeroomDashboardPeriod = 'week'; // 'day' | 'week' | 'month'
    let homeroomDashboardDate = new Date().toISOString().split('T')[0]; // YYYY-MM-DD


    const defaultConfig = {
      school_name: 'SMP Pasundan 4 Bandung',
      primary_color: '#1e3a5f',
      accent_color: '#f59e0b',
      text_color: '#1f2937',
      bg_color: '#f3f4f6',
      card_color: '#ffffff',
      // Permissions config
      permissions: {
        assignedTeacherCanEdit: true, // allow teacher assigned to class to edit entries by default
        assignedTeacherCanDelete: false // do not allow assigned teachers to delete by default
      }
    };

    const CLASSES = ['7A', '7B', '7C', '7D', '7E', '7F', '7G', '7H', '7I', '7J', '8A', '8B', '8C', '8D', '8E', '8F', '8G', '8H', '8I', '8J', '9A', '9B', '9C', '9D', '9E', '9F', '9G', '9H', '9I', '9J'];
    const SUBJECTS = ['Matematika', 'Bahasa Indonesia', 'Bahasa Inggris', 'IPA', 'IPS', 'PKn', 'Pendidikan Agama', 'Seni Budaya', 'PJOK', 'Prakarya', 'Bahasa Sunda','Informatika','Tahsin', 'Tahfidz'];
    const ASSESSMENT_TYPES = [
      { value: 'task1', label: 'Tugas 1' },
      { value: 'task2', label: 'Tugas 2' },
      { value: 'task3', label: 'Tugas 3' },
      { value: 'task4', label: 'Tugas 4' },
      { value: 'task5', label: 'Tugas 5' },
      { value: 'task6', label: 'Tugas 6' },
      { value: 'task7', label: 'Tugas 7' },
      { value: 'task8', label: 'Tugas 8' },
      { value: 'task9', label: 'Tugas 9' },
      { value: 'task10', label: 'Tugas 10' },
      { value: 'daily_test', label: 'Ulangan Harian' },
      { value: 'exam', label: 'Ujian' }
    ];

    let attendanceData = {};
    let gradeData = {};
    let totalStudentsForAttendance = 0;
    let totalStudentsForGrade = 0;

    function showToast(message, type = 'success') {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
    function formatDate(date) { return new Date(date).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }); }
    function getTeachers() { return allData.filter(d => d.type === 'teacher'); }
    function getHomerooms() { return allData.filter(d => d.type === 'homeroom'); }
    function getStudents() { return allData.filter(d => d.type === 'student'); }
    function getAttendance() { return allData.filter(d => d.type === 'attendance'); }
    function getTeacherAttendance() { return allData.filter(d => d.type === 'teacher_attendance'); }
    function getGrades() { return allData.filter(d => d.type === 'grade'); }
    function getAccounts() { return allData.filter(d => d.type === 'account'); }

    // session helpers: persist current user so login survives page refresh
    function setCurrentUser(user) {
      currentUser = user;
      try { localStorage.setItem('absensi_current_user', JSON.stringify(user)); } catch (e) { console.warn('Failed to persist current user', e); }
    }
    function clearCurrentUser() {
      currentUser = null;
      try { localStorage.removeItem('absensi_current_user'); } catch (e) { console.warn('Failed to clear current user', e); }
    }

    function exportToExcel(data, filename) {
      if (!data || data.length === 0) return;
      // Determine headers (exclude internal fields)
      const headers = Object.keys(data[0]).filter(k => !k.startsWith('__') && k !== 'type');

      // If SheetJS is available, generate real .xlsx
      if (window.XLSX) {
        // Map data rows keeping only headers (and preserving order)
        const rows = data.map(r => {
          const obj = {};
          headers.forEach(h => obj[h] = r[h] ?? '');
          return obj;
        });
        const ws = XLSX.utils.json_to_sheet(rows, {header: headers});
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Data');
        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([wbout], { type: 'application/octet-stream' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${filename}.xlsx`;
        link.click();
        return;
      }

      // Fallback to CSV for environments without SheetJS
      let csv = '\ufeff';
      csv += headers.join(',') + '\n';
      data.forEach(row => {
        const values = headers.map(h => `"${String(row[h] || '').replace(/"/g, '""')}"`);
        csv += values.join(',') + '\n';
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${filename}.csv`;
      link.click();
    }

    function render() {
      const app = document.getElementById('app');
      if (!currentUser) {
        renderLogin();
      } else {
        switch(currentUser.role) {
          case 'admin': renderAdminDashboard(); break;
          case 'teacher': renderTeacherDashboard(); break;
          case 'homeroom': renderHomeroomDashboard(); break;
          case 'student': renderStudentDashboard(); break;
        }
      }
      // ensure footer is present on every view
      renderFooter();
    }

    function renderLogin() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="h-full flex items-center justify-center p-4" style="background: linear-gradient(rgba(0,0,0,0.45), rgba(0,0,0,0.45)), url('sekolahsmppasundan4.jpg'); background-size: cover; background-position: center; background-repeat: no-repeat;">
          <div class="rounded-2xl card-shadow p-8 w-full max-w-md animate-fade" style="background-color: rgba(255,255,255,0.75);">
            <div class="text-center mb-8">
              <div class="w-20 h-20 mx-auto mb-4 rounded-full overflow-hidden bg-white flex items-center justify-center">
                <img src="logosmppas4.jpg" alt="Logo SMP Pasundan 4" class="w-full h-full object-cover">
              </div>
              <h1 class="text-2xl font-bold text-gray-800" id="school-title">${config.school_name || defaultConfig.school_name}</h1>
              <p class="text-gray-500 mt-2">Sistem Informasi Absensi & Nilai</p>
            </div>
            <form id="loginForm" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="username">Username</label>
                <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition" placeholder="Masukkan username" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="password">Password</label>
                <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition" placeholder="Masukkan password" required>
              </div>
              <button type="submit" class="w-full btn-primary text-white font-semibold py-3 rounded-lg transition transform hover:scale-[1.02] active:scale-[0.98]">Masuk</button>
            </form>
            <div class="mt-6 p-4 bg-gray-50 rounded-lg">
              <p class="text-xs text-gray-500 text-center">Silahkan Login Dengar Benar!ðŸ¤“</p>
            </div>
          </div>
        </div>
      `;
      document.getElementById('loginForm').addEventListener('submit', handleLogin);
    }

    async function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      if (username === 'admin' && password === 'p4sund4n') {
        setCurrentUser({ role: 'admin', name: 'Administrator' });
        render();
        return;
      }
      const account = getAccounts().find(a => a.username === username && a.password === password);
      if (account) {
        // store extra useful info so session can be restored
        setCurrentUser({ role: account.role, name: account.name, id: account.ref_id, class_name: account.class_name, subject: account.subject, username: account.username, accountId: account.__backendId });
        render();
      } else {
        showToast('Username atau password salah!ðŸ¥¹', 'error');
      }
    }

    function logout() {
      clearCurrentUser();
      selectedClass = null;
      selectedSubject = null;
      attendanceData = {};
      gradeData = {};
      try { localStorage.removeItem('absensi_admin_view'); } catch (e) {}
      currentAdminView = 'dashboard';
      render();
    }

    // Footer: shown at the bottom of every page
    function renderFooter() {
      let f = document.getElementById('siteFooter');
      if (!f) {
        f = document.createElement('div');
        f.id = 'siteFooter';
        f.className = 'fixed bottom-0 left-0 right-0 text-center text-xs text-gray-600 py-2 border-t';
        f.setAttribute('style', 'background-color: rgba(255,255,255,0.40); backdrop-filter: blur(2px);');
        document.body.appendChild(f);
        // ensure content is not hidden behind footer
        document.body.style.paddingBottom = '15px';
      }
      f.innerHTML = '2025 All Rights Reserved. Design By NA-78';
    }

    function renderAdminDashboard() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="h-full flex">
          <div class="hidden md:flex w-64 gradient-bg text-white flex flex-col">
            <div class="p-6 border-b border-white/20">
              <div class="flex items-center gap-3">
                <img src="logosmppas4.jpg" alt="Logo" class="w-10 h-10 rounded-full object-cover">
                <div>
                  <h2 class="font-bold text-lg">${config.school_name || defaultConfig.school_name}</h2>
                  <p class="text-sm text-white/70">Panel Admin</p>
                </div>
              </div>
            </div>
            <nav class="flex-1 p-4 space-y-2">
              <button onclick="setAdminView('dashboard')" class="sidebar-item active w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition" data-view="dashboard">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6z"/></svg>
                Dashboard
              </button>
              <button onclick="setAdminView('teachers')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition" data-view="teachers">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                Data Guru
              </button>
              <button onclick="setAdminView('homerooms')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition" data-view="homerooms">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5"/></svg>
                Wali Kelas
              </button>
              <button onclick="setAdminView('students')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition" data-view="students">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                Data Siswa
              </button>
              <button onclick="setAdminView('accounts')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition" data-view="accounts">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>
                Kelola Akun
              </button>
              <button onclick="setAdminView('reports')" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition" data-view="reports">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                Laporan
              </button>
            </nav>
            <div class="p-4 border-t border-white/20">
              <button onclick="logout()" class="w-full px-4 py-2 bg-red-500/20 hover:bg-red-500/30 rounded-lg text-red-200 transition flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                Keluar
              </button>
            </div>
          </div>
          <div class="flex-1 overflow-auto">
            <!-- Mobile top bar (visible on small screens) -->
            <div class="p-4 md:hidden bg-white/5 flex items-center justify-between">
              <button onclick="toggleMobileSidebar()" class="px-3 py-2 rounded-lg bg-white/10 text-white">â˜°</button>
              <div class="flex items-center gap-3">
                <img src="logosmppas4.jpg" alt="Logo" class="w-8 h-8 rounded-full object-cover">
                <div class="text-sm font-medium text-gray-100">${config.school_name || defaultConfig.school_name}</div>
              </div>
              <div></div>
            </div>
            <div class="p-6" id="adminContent"></div>
          </div>
        </div>
      `;
      setAdminView(currentAdminView || 'dashboard');
    }

    let currentAdminView = 'dashboard';

    function setAdminView(view) {
      currentAdminView = view;
      try { localStorage.setItem('absensi_admin_view', view); } catch (e) {}
      document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.view === view) item.classList.add('active');
      });
      const content = document.getElementById('adminContent');
      switch(view) {
        case 'dashboard': renderAdminDashboardContent(content); break;
        case 'teachers': renderTeachersManagement(content); break;
        case 'homerooms': renderHomeroomsManagement(content); break;
        case 'students': renderStudentsManagement(content); break;
        case 'accounts': renderAccountsManagement(content); break;
        case 'reports': renderReportsManagement(content); break;
      }
    }

    function renderAdminDashboardContent(container) {
      const teachers = getTeachers();
      const homerooms = getHomerooms();
      const students = getStudents();
      const attendance = getAttendance();
      const todayAttendance = attendance.filter(a => a.date === new Date().toISOString().split('T')[0]);
      const presentToday = todayAttendance.filter(a => a.status === 'hadir').length;
      
      container.innerHTML = `
        <div class="animate-fade">
          <h1 class="text-2xl font-bold text-gray-800 mb-6">Dashboard Admin</h1>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 card-shadow border-l-4 border-blue-500">
              <div class="flex items-center justify-between">
                <div><p class="text-gray-500 text-sm">Total Guru</p><p class="text-3xl font-bold text-gray-800">${teachers.length}</p></div>
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                  <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl p-6 card-shadow border-l-4 border-green-500">
              <div class="flex items-center justify-between">
                <div><p class="text-gray-500 text-sm">Wali Kelas</p><p class="text-3xl font-bold text-gray-800">${homerooms.length}</p></div>
                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                  <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5"/></svg>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl p-6 card-shadow border-l-4 border-amber-500">
              <div class="flex items-center justify-between">
                <div><p class="text-gray-500 text-sm">Total Siswa</p><p class="text-3xl font-bold text-gray-800">${students.length}</p></div>
                <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center">
                  <svg class="w-6 h-6 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl p-6 card-shadow border-l-4 border-purple-500">
              <div class="flex items-center justify-between">
                <div><p class="text-gray-500 text-sm">Hadir Hari Ini</p><p class="text-3xl font-bold text-gray-800">${presentToday}</p></div>
                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                  <svg class="w-6 h-6 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl p-6 card-shadow mb-6">
            <h3 class="font-semibold text-gray-800 mb-4">Maintenance</h3>
            <p class="text-sm text-gray-600 mb-4">Opsi admin untuk menghapus seluruh data tertentu (Akun, Guru, Siswa, Wali Kelas). Gunakan dengan hati-hati.</p>
            <div class="flex gap-3">
              <button onclick="showPurgeDataModal()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg">Hapus Semua Data</button>
              <button onclick="showPurgeDataModal()" class="px-4 py-2 border border-gray-300 rounded-lg">Opsi Lanjutan</button>
            </div>
          </div>
          <div class="bg-white rounded-xl p-6 card-shadow">
            <h3 class="font-semibold text-gray-800 mb-4">Statistik Per Kelas</h3>
            <div class="space-y-4">
              <!-- Grade 7 -->
              <div>
                <h4 class="text-sm font-semibold text-gray-700 mb-2">Kelas 7</h4>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-3">
                  ${CLASSES.filter(c => c.startsWith('7')).map(cls => {
                    const count = students.filter(s => s.class_name === cls).length;
                    return `<div class="p-3 bg-gray-50 rounded-lg text-center"><p class="text-xs text-gray-500">Kelas ${cls}</p><p class="text-xl font-bold text-gray-800">${count}</p></div>`;
                  }).join('')}
                </div>
              </div>
              <!-- Grade 8 -->
              <div>
                <h4 class="text-sm font-semibold text-gray-700 mb-2">Kelas 8</h4>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-3">
                  ${CLASSES.filter(c => c.startsWith('8')).map(cls => {
                    const count = students.filter(s => s.class_name === cls).length;
                    return `<div class="p-3 bg-gray-50 rounded-lg text-center"><p class="text-xs text-gray-500">Kelas ${cls}</p><p class="text-xl font-bold text-gray-800">${count}</p></div>`;
                  }).join('')}
                </div>
              </div>
              <!-- Grade 9 -->
              <div>
                <h4 class="text-sm font-semibold text-gray-700 mb-2">Kelas 9</h4>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-3">
                  ${CLASSES.filter(c => c.startsWith('9')).map(cls => {
                    const count = students.filter(s => s.class_name === cls).length;
                    return `<div class="p-3 bg-gray-50 rounded-lg text-center"><p class="text-xs text-gray-500">Kelas ${cls}</p><p class="text-xl font-bold text-gray-800">${count}</p></div>`;
                  }).join('')}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderTeachersManagement(container) {
      const teachers = getTeachers();
      container.innerHTML = `
        <div class="animate-fade">
          <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Data Guru</h1>
            <div class="flex gap-2">
              <button onclick="exportTeachers()" class="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v13m0 0l-4-4m4 4l4-4M4 20h16"/></svg>
                Download Excel
              </button>
              <button onclick="showAddTeacherModal()" class="btn-primary text-white px-4 py-2 rounded-lg flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                Tambah Guru
              </button>
            </div>
          </div>
          <div class="bg-white rounded-xl card-shadow overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">No</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Nama</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Kode Guru</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Mata Pelajaran</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Kelas</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Aksi</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                  ${teachers.length === 0 ? `<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">Belum ada data guru</td></tr>` : teachers.map((t, i) => `
                    <tr class="table-row">
                      <td class="px-6 py-4 text-sm text-gray-600">${i + 1}</td>
                      <td class="px-6 py-4 text-sm font-medium text-gray-800">${t.name}</td>
                      <td class="px-6 py-4 text-sm text-gray-600">${t.kode_guru || t.nip || '-'}</td>
                      <td class="px-6 py-4 text-sm text-gray-600">${t.subject || '-'}</td>
                      <td class="px-6 py-4 text-sm text-gray-600">${t.class_name || '-'}</td>
                      <td class="px-6 py-4">
                        <div class="flex gap-2">
                          <button onclick="editTeacher('${t.__backendId}')" class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg></button>
                          <button onclick="deleteTeacher('${t.__backendId}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    function exportTeachers() {
      const data = getTeachers();
      if (!data || data.length === 0) { showToast('Belum ada data guru untuk diunduh', 'error'); return; }
      exportToExcel(data, `data_guru_${new Date().toISOString().split('T')[0]}`);
    }

    // Export multiple sheets (works with SheetJS) and CSV fallback
    function exportMultipleSheets(sheetsObj, filename) {
      if (window.XLSX) {
        const wb = XLSX.utils.book_new();
        for (const [name, rows] of Object.entries(sheetsObj)) {
          const ws = XLSX.utils.json_to_sheet(rows || []);
          XLSX.utils.book_append_sheet(wb, ws, name);
        }
        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([wbout], { type: 'application/octet-stream' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${filename}.xlsx`;
        link.click();
        return;
      }

      // Fallback: combine sheets into simple CSV with section headers
      let csv = '\ufeff';
      for (const [name, rows] of Object.entries(sheetsObj)) {
        csv += `=== ${name} ===\n`;
        if (!rows || rows.length === 0) { csv += '\n'; continue; }
        const headers = Object.keys(rows[0]);
        csv += headers.join(',') + '\n';
        rows.forEach(r => {
          const vals = headers.map(h => `"${String(r[h] || '').replace(/"/g, '""')}"`);
          csv += vals.join(',') + '\n';
        });
        csv += '\n';
      }
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${filename}.csv`;
      link.click();
    }

    // Mobile sidebar for small screens
    function toggleMobileSidebar() {
      const existing = document.getElementById('mobileSidebar');
      if (existing) { existing.remove(); return; }
      const sidebar = document.createElement('div');
      sidebar.id = 'mobileSidebar';
      sidebar.className = 'fixed inset-0 z-50';
      sidebar.innerHTML = `
        <div class="fixed inset-0 modal-overlay" onclick="closeMobileSidebar()"></div>
        <div class="absolute left-0 top-0 bottom-0 w-72 bg-gradient-to-b from-[#1e3a5f] to-[#2d5a87] text-white p-4 overflow-auto">
          <div class="flex items-center justify-between mb-4">
            <div class="font-bold">${config.school_name || defaultConfig.school_name}</div>
            <button onclick="closeMobileSidebar()" class="text-white/80 px-2 py-1 rounded">âœ•</button>
          </div>
          <nav class="space-y-2">
            <button onclick="setAdminView('dashboard'); closeMobileSidebar()" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition">Dashboard</button>
            <button onclick="setAdminView('teachers'); closeMobileSidebar()" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition">Data Guru</button>
            <button onclick="setAdminView('homerooms'); closeMobileSidebar()" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition">Wali Kelas</button>
            <button onclick="setAdminView('students'); closeMobileSidebar()" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition">Data Siswa</button>
            <button onclick="setAdminView('accounts'); closeMobileSidebar()" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition">Kelola Akun</button>
            <button onclick="setAdminView('reports'); closeMobileSidebar()" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition">Laporan</button>
          </nav>
        </div>
      `;
      document.body.appendChild(sidebar);
    }

    function closeMobileSidebar() { const s = document.getElementById('mobileSidebar'); if (s) s.remove(); }

    window.addEventListener('resize', () => { if (window.innerWidth >= 768) closeMobileSidebar(); });

    function exportHomeroom(className) {
      const period = homeroomDashboardPeriod || 'week';
      const dateStr = homeroomDashboardDate || new Date().toISOString().split('T')[0];
      // reuse the same range logic
      function getRange(period, dateObj) {
        const d = new Date(dateObj);
        d.setHours(0,0,0,0);
        if (period === 'day') return { start: new Date(d), end: new Date(d) };
        if (period === 'week') { const day = d.getDay(); const diffToMonday = (day + 6) % 7; const start = new Date(d); start.setDate(d.getDate() - diffToMonday); start.setHours(0,0,0,0); const end = new Date(start); end.setDate(start.getDate() + 6); end.setHours(23,59,59,999); return { start, end }; }
        const start = new Date(d.getFullYear(), d.getMonth(), 1); const end = new Date(d.getFullYear(), d.getMonth() + 1, 0, 23,59,59,999); return { start, end };
      }
      function inRange(itemDateStr, start, end) { if (!itemDateStr) return false; const d = new Date(itemDateStr); return d >= start && d <= end; }
      const range = getRange(period, new Date(dateStr));

      // Filter attendance and grades for this homeroom and period
      const attendanceInRange = getAttendance().filter(a => a.class_name === className && inRange(a.date || a.created_at, range.start, range.end));
      const gradesInRange = getGrades().filter(g => g.class_name === className && inRange(g.date || g.created_at, range.start, range.end));
      const studentsInClass = getStudents().filter(s => s.class_name === className).sort((a,b) => (a.name||'').localeCompare(b.name));

      // Subjects touched by either attendance or grades (plus known SUBJECTS)
      const subjectsSet = new Set();
      attendanceInRange.forEach(a => { if (a.subject) subjectsSet.add(a.subject); });
      gradesInRange.forEach(g => { if (g.subject) subjectsSet.add(g.subject); });
      SUBJECTS.forEach(s => subjectsSet.add(s));
      const subjects = Array.from(subjectsSet).sort();

      // Summary rows (per subject)
      const attendanceSummaryRows = subjects.map(sub => {
        const list = attendanceInRange.filter(a => (a.subject || '').toLowerCase() === sub.toLowerCase());
        return { Subject: sub, Total: list.length, Hadir: list.filter(x => x.status === 'hadir').length, Izin: list.filter(x => x.status === 'izin').length, Sakit: list.filter(x => x.status === 'sakit').length, Alpa: list.filter(x => x.status === 'alpha').length };
      });

      const gradesSummaryRows = subjects.map(sub => {
        const list = gradesInRange.filter(g => (g.subject || '').toLowerCase() === sub.toLowerCase());
        const finals = list.map(g => {
          const tasks = [g.task1, g.task2, g.task3, g.task4, g.task5].filter(t => t != null);
          const taskAvg = tasks.length > 0 ? tasks.reduce((a,b)=>a+b,0)/tasks.length : 0;
          const finalGrade = (taskAvg * 0.4) + ((g.daily_test || 0) * 0.3) + ((g.exam || 0) * 0.3);
          return finalGrade;
        });
        const avgFinal = finals.length > 0 ? (finals.reduce((a,b)=>a+b,0)/finals.length) : null;
        return { Subject: sub, AvgFinal: avgFinal !== null ? avgFinal.toFixed(1) : '', Entries: finals.length };
      });

      // Detailed rows per student
      const studentsRows = studentsInClass.map(s => ({ Name: s.name || '', NIS: s.nis || '', Class: s.class_name || '', 'Created At': s.created_at || '' }));

      const gradesDetailRows = gradesInRange.map(g => {
        const student = getStudents().find(s => s.__backendId === g.student_id) || {};
        const tasks = [g.task1, g.task2, g.task3, g.task4, g.task5].map(t => (t != null ? t : ''));
        const taskVals = tasks.filter(t => t !== '');
        const taskAvg = taskVals.length > 0 ? taskVals.reduce((a,b)=>a+b,0)/taskVals.length : 0;
        const finalGrade = (taskAvg * 0.4) + ((g.daily_test || 0) * 0.3) + ((g.exam || 0) * 0.3);
        return {
          Name: student.name || '',
          NIS: student.nis || '',
          Class: g.class_name || '',
          Date: g.date || g.created_at || '',
          Subject: g.subject || '',
          Task1: g.task1 || '', Task2: g.task2 || '', Task3: g.task3 || '', Task4: g.task4 || '', Task5: g.task5 || '',
          UH: g.daily_test || '', Exam: g.exam || '', FinalGrade: finalGrade ? finalGrade.toFixed(1) : ''
        };
      });

      const attendanceDetailRows = attendanceInRange.map(a => {
        const student = getStudents().find(s => s.__backendId === a.student_id) || {};
        return { Name: student.name || '', NIS: student.nis || '', Class: a.class_name || '', Date: a.date || a.created_at || '', Subject: a.subject || '', Status: a.status };
      });

      // Grades by student: matrix with subjects as columns (one row per student)
      const gradesByStudentRows = studentsInClass.map(s => {
        const row = { Name: s.name || '', NIS: s.nis || '', Class: s.class_name || '' };
        let sumAll = 0, cntAll = 0;
        subjects.forEach(sub => {
          const list = gradesInRange.filter(g => g.student_id === s.__backendId && (g.subject || '').toLowerCase() === sub.toLowerCase());
          if (!list || list.length === 0) { row[sub] = ''; }
          else {
            const finals = list.map(g => {
              const tasks = [g.task1, g.task2, g.task3, g.task4, g.task5].filter(t => t != null);
              const taskAvg = tasks.length > 0 ? tasks.reduce((a,b)=>a+b,0)/tasks.length : 0;
              const finalGrade = (taskAvg * 0.4) + ((g.daily_test || 0) * 0.3) + ((g.exam || 0) * 0.3);
              return finalGrade;
            });
            const avgFinal = finals.length > 0 ? (finals.reduce((a,b)=>a+b,0)/finals.length) : null;
            row[sub] = avgFinal !== null ? avgFinal.toFixed(1) : '';
            if (avgFinal !== null) { sumAll += avgFinal; cntAll++; }
          }
        });
        row['Average'] = cntAll > 0 ? (sumAll / cntAll).toFixed(1) : '';
        return row;
      });

      // Export only Attendance Summary and Grades by Student (per request)
      exportMultipleSheets({ 'Attendance Summary': attendanceSummaryRows, 'Grades by Student': gradesByStudentRows }, `homeroom_${className}_${dateStr}_${period}`);
    }

    function exportStudentInRange(studentId) {
      const period = homeroomDashboardPeriod || 'week';
      const dateStr = homeroomDashboardDate || new Date().toISOString().split('T')[0];
      function getRange(period, dateObj) {
        const d = new Date(dateObj);
        d.setHours(0,0,0,0);
        if (period === 'day') return { start: new Date(d), end: new Date(d) };
        if (period === 'week') { const day = d.getDay(); const diffToMonday = (day + 6) % 7; const start = new Date(d); start.setDate(d.getDate() - diffToMonday); start.setHours(0,0,0,0); const end = new Date(start); end.setDate(start.getDate() + 6); end.setHours(23,59,59,999); return { start, end }; }
        const start = new Date(d.getFullYear(), d.getMonth(), 1); const end = new Date(d.getFullYear(), d.getMonth() + 1, 0, 23,59,59,999); return { start, end };
      }
      function inRange(itemDateStr, start, end) { if (!itemDateStr) return false; const d = new Date(itemDateStr); return d >= start && d <= end; }
      const range = getRange(period, new Date(dateStr));
      const attendanceList = getAttendance().filter(a => a.student_id === studentId && inRange(a.date || a.created_at, range.start, range.end));
      const gradesList = getGrades().filter(g => g.student_id === studentId && inRange(g.date || g.created_at, range.start, range.end));
      const student = getStudents().find(s => s.__backendId === studentId) || { name: studentId };
      const attendanceRows = attendanceList.map(a => ({ date: a.date || a.created_at, subject: a.subject || '-', status: a.status }));
      const gradesRows = gradesList.map(g => {
        const tasks = [g.task1, g.task2, g.task3, g.task4, g.task5].filter(t => t != null);
        const taskAvg = tasks.length > 0 ? tasks.reduce((a,b)=>a+b,0)/tasks.length : 0;
        const finalGrade = (taskAvg * 0.4) + ((g.daily_test || 0) * 0.3) + ((g.exam || 0) * 0.3);
        return { date: g.date || g.created_at, subject: g.subject, finalGrade };
      });
      exportMultipleSheets({ 'Attendance': attendanceRows, 'Grades': gradesRows }, `student_${student.name || studentId}_${dateStr}_${period}`);
    }

    function showStudentDetailModal(studentId) {
      const student = getStudents().find(s => s.__backendId === studentId);
      if (!student) { showToast('Siswa tidak ditemukan', 'error'); return; }
      const period = homeroomDashboardPeriod || 'week';
      const dateStr = homeroomDashboardDate || new Date().toISOString().split('T')[0];
      function getRange(period, dateObj) {
        const d = new Date(dateObj); d.setHours(0,0,0,0); if (period === 'day') return { start: new Date(d), end: new Date(d) }; if (period === 'week') { const day = d.getDay(); const diffToMonday = (day + 6) % 7; const start = new Date(d); start.setDate(d.getDate() - diffToMonday); start.setHours(0,0,0,0); const end = new Date(start); end.setDate(start.getDate() + 6); end.setHours(23,59,59,999); return { start, end }; } const start = new Date(d.getFullYear(), d.getMonth(), 1); const end = new Date(d.getFullYear(), d.getMonth() + 1, 0, 23,59,59,999); return { start, end };
      }
      function inRange(itemDateStr, start, end) { if (!itemDateStr) return false; const d = new Date(itemDateStr); return d >= start && d <= end; }
      const range = getRange(period, new Date(dateStr));
      const attendanceList = getAttendance().filter(a => a.student_id === studentId && inRange(a.date || a.created_at, range.start, range.end));
      const gradesList = getGrades().filter(g => g.student_id === studentId && inRange(g.date || g.created_at, range.start, range.end));

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50';
      modal.id = 'modal';
      modal.innerHTML = `
        <div class="bg-white rounded-xl card-shadow w-full max-w-2xl mx-4 animate-fade max-h-[90%] overflow-auto">
          <div class="p-6 border-b flex items-center justify-between"><h3 class="text-lg font-semibold">Detail Siswa - ${student.name}</h3><div><button onclick="exportStudentInRange('${studentId}')" class="px-3 py-1 bg-gray-100 rounded-lg mr-2">Ekspor</button><button onclick="closeModal()" class="px-3 py-1 border rounded-lg">Tutup</button></div></div>
          <div class="p-6 space-y-4">
            <div>
              <h4 class="font-medium text-gray-700 mb-2">Absensi (${period} - ${dateStr})</h4>
              ${attendanceList.length === 0 ? '<p class="text-gray-500">Tidak ada data absensi</p>' : `<div class="overflow-x-auto"><table class="w-full text-sm"><thead class="bg-gray-50"><tr><th class="px-4 py-2 text-left">Tanggal</th><th class="px-4 py-2 text-left">Mata Pelajaran</th><th class="px-4 py-2 text-left">Status</th><th class="px-4 py-2 text-left">Aksi</th></tr></thead><tbody class="divide-y">${attendanceList.map(a => `<tr><td class="px-4 py-2">${a.date || a.created_at}</td><td class="px-4 py-2">${a.subject || '-'}</td><td class="px-4 py-2">${a.status}</td><td class="px-4 py-2"><div class="flex gap-2"><button onclick="editAttendance('${a.__backendId}')" class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg">Edit</button><button onclick="deleteAttendance('${a.__backendId}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">Hapus</button></div></td></tr>`).join('')}</tbody></table></div>`}
            </div>
            <div>
              <h4 class="font-medium text-gray-700 mb-2">Nilai (${period} - ${dateStr})</h4>
              ${gradesList.length === 0 ? '<p class="text-gray-500">Belum ada nilai</p>' : `<div class="space-y-2">${gradesList.map(g => {
                const tasks = [g.task1, g.task2, g.task3, g.task4, g.task5].filter(t => t != null);
                const taskAvg = tasks.length > 0 ? tasks.reduce((a,b)=>a+b,0)/tasks.length : 0;
                const finalGrade = (taskAvg * 0.4) + ((g.daily_test || 0) * 0.3) + ((g.exam || 0) * 0.3);
                return `<div class="p-3 rounded-lg bg-gray-50"><div class="flex items-center justify-between"><p class="font-medium text-gray-800">${g.subject}</p><div class="flex items-center gap-2"><span class="px-2 py-1 ${finalGrade >= 75 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} rounded-full font-bold">${finalGrade.toFixed(1)}</span><button onclick="editGrade('${g.__backendId}')" class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg">Edit</button><button onclick="deleteGrade('${g.__backendId}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">Hapus</button></div></div><div class="text-xs text-gray-500">Tanggal: ${g.date || g.created_at}</div></div>`;
              }).join('')}</div>`}
            </div>
          </div> 
        </div>
      `;
      document.body.appendChild(modal);
    }

    function showAddTeacherModal(teacher = null) {
      const isEdit = teacher !== null;
      const modal = document.createElement('div');
      modal.id = 'modal';
      modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-xl card-shadow w-full max-w-md mx-4 animate-fade max-h-[90%] overflow-auto">
          <div class="p-6 border-b"><h3 class="text-lg font-semibold text-gray-800">${isEdit ? 'Edit' : 'Tambah'} Guru</h3></div>
          <form id="teacherForm" class="p-6 space-y-4">
            <div><label class="block text-sm font-medium text-gray-700 mb-1" for="teacherName">Nama Lengkap</label><input type="text" id="teacherName" value="${teacher?.name || ''}" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500" required></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-1" for="teacherKode">Kode Guru</label><input type="text" id="teacherKode" value="${teacher?.kode_guru || teacher?.nip || ''}" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500" required></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-1" for="teacherSubject">Mata Pelajaran</label><select id="teacherSubject" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500" multiple size="4">${SUBJECTS.map(s => `<option value="${s}" ${teacher?.subject?.includes(s) ? 'selected' : ''}>${s}</option>`).join('')}</select><p class="text-xs text-gray-500 mt-1">Tahan Ctrl untuk pilih lebih dari satu</p></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-1" for="teacherClass">Kelas Mengajar</label><select id="teacherClass" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500" multiple size="4">${CLASSES.map(c => `<option value="${c}" ${teacher?.class_name?.includes(c) ? 'selected' : ''}>Kelas ${c}</option>`).join('')}</select></div>
            <div class="flex gap-3 pt-4">
              <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Batal</button>
              <button type="submit" class="flex-1 btn-primary text-white px-4 py-2 rounded-lg">${isEdit ? 'Simpan' : 'Tambah'}</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
      const form = document.getElementById('teacherForm');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = form.querySelector('button[type="submit"]');
        const name = document.getElementById('teacherName').value.trim();
        const kode = document.getElementById('teacherKode').value.trim();
        const subjects = Array.from(document.getElementById('teacherSubject').selectedOptions).map(o => o.value).join(',');
        const classes = Array.from(document.getElementById('teacherClass').selectedOptions).map(o => o.value).join(',');
        if (!name || !kode) { showToast('Nama dan Kode Guru wajib diisi!', 'error'); return; }
        // prevent duplicate kode (ignore current teacher when editing)
        const existingByCode = getTeachers().find(t => (t.kode_guru === kode || t.nip === kode) && (!isEdit || t.__backendId !== teacher.__backendId));
        if (existingByCode) { showToast('Kode Guru sudah terdaftar!', 'error'); return; }

        // disable submit while saving
        const originalText = submitBtn ? submitBtn.textContent : null;
        if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = isEdit ? 'Menyimpan...' : 'Menambahkan...'; }

        try {
          if (isEdit) {
            const result = await window.dataSdk.update({ ...teacher, name, kode_guru: kode, subject: subjects, class_name: classes });
            if (!result || !result.isOk) { showToast(result?.error || 'Gagal memperbarui data!', 'error'); return; }
            // update associated account if exists
            const account = getAccounts().find(a => a.ref_id === teacher.__backendId);
            if (account) {
              const accRes = await window.dataSdk.update({ ...account, name, class_name: classes, subject: subjects });
              if (!accRes || !accRes.isOk) showToast('Gagal memperbarui akun terkait', 'error');
            }
            showToast('Data guru berhasil diperbarui!');
            setAdminView('teachers');
            closeModal();
          } else {
            if (allData.length >= 999) { showToast('Batas maksimal 999 data tercapai!', 'error'); return; }
            const result = await window.dataSdk.create({ type: 'teacher', name, kode_guru: kode, subject: subjects, class_name: classes, created_at: new Date().toISOString() });
            if (!result || !result.isOk) { showToast(result?.error || 'Gagal menambahkan guru!', 'error'); return; }

            // Poll for created teacher to appear in local cache
            let created = null;
            for (let i = 0; i < 10; i++) {
              created = getTeachers().find(t => (t.kode_guru === kode || t.nip === kode) && t.name === name);
              if (created) break;
              await new Promise(r => setTimeout(r, 300));
            }

            if (!created) {
              showToast('Guru ditambahkan, tetapi belum ter-sinkron. Silakan muat ulang.', 'error');
              setAdminView('teachers');
              closeModal();
              return;
            }

            // create account if missing
            const accExists = getAccounts().find(a => a.ref_id === created.__backendId);
            if (!accExists) {
              const username = kode || (name.toLowerCase().replace(/\s+/g,'').slice(0,8) + Math.floor(Math.random()*1000));
              const password = kode || 'guru123';
              const accRes = await window.dataSdk.create({ type: 'account', name, username, password, role: 'teacher', ref_id: created.__backendId, class_name: classes, subject: subjects, created_at: new Date().toISOString() });
              if (accRes && accRes.isOk) showToast('Akun guru dibuat: ' + username);
              else showToast('Guru ditambahkan, tetapi gagal membuat akun.', 'error');
            }

            showToast('Guru berhasil ditambahkan!');
            setAdminView('teachers');
            closeModal();
          }
        } catch (err) {
          console.error(err);
          showToast('Terjadi kesalahan saat menyimpan data', 'error');
        } finally {
          if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = originalText; }
        }
      });
    }

    function editTeacher(id) { const teacher = allData.find(d => d.__backendId === id); if (teacher) showAddTeacherModal(teacher); }
    
    async function deleteTeacher(id) {
      const teacher = allData.find(d => d.__backendId === id);
      if (!teacher) return;
      showConfirmModal('Hapus Guru', `Yakin ingin menghapus guru ${teacher.name}?`, async () => {
        const result = await window.dataSdk.delete(teacher);
        if (result.isOk) { showToast('Guru berhasil dihapus!'); const account = getAccounts().find(a => a.ref_id === id); if (account) await window.dataSdk.delete(account); }
        else showToast('Gagal menghapus guru!', 'error');
      });
    }

    function renderHomeroomsManagement(container) {
      const homerooms = getHomerooms();
      container.innerHTML = `
        <div class="animate-fade">
          <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Data Wali Kelas</h1>
            <button onclick="showAddHomeroomModal()" class="btn-primary text-white px-4 py-2 rounded-lg flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
              Tambah Wali Kelas
            </button>
          </div>
          <div class="bg-white rounded-xl card-shadow overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">No</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Nama</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Kode Guru</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Kelas</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Jumlah Siswa</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Aksi</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                  ${homerooms.length === 0 ? `<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">Belum ada data wali kelas</td></tr>` : homerooms.map((h, i) => {
                    const studentCount = getStudents().filter(s => s.class_name === h.class_name).length;
                    return `<tr class="table-row">
                      <td class="px-6 py-4 text-sm text-gray-600">${i + 1}</td>
                      <td class="px-6 py-4 text-sm font-medium text-gray-800">${h.name}</td>
                      <td class="px-6 py-4 text-sm text-gray-600">${h.kode_guru || h.nip || '-'}</td>
                      <td class="px-6 py-4"><span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium">${h.class_name}</span></td>
                      <td class="px-6 py-4 text-sm text-gray-600">${studentCount} siswa</td>
                      <td class="px-6 py-4">
                        <div class="flex gap-2">
                          <button onclick="editHomeroom('${h.__backendId}')" class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg></button>
                          <button onclick="deleteHomeroom('${h.__backendId}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
                        </div>
                      </td>
                    </tr>`;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    function showAddHomeroomModal(homeroom = null) {
      const isEdit = homeroom !== null;
      // allow selecting from existing teachers; exclude teachers already assigned to other homerooms (unless editing current)
      const teachers = getTeachers();
      const assignedTeacherIds = getHomerooms().filter(h => h.__backendId !== homeroom?.__backendId).map(h => h.ref_teacher_id).filter(Boolean);
      const availableClasses = CLASSES.filter(c => !getHomerooms().filter(h => h.__backendId !== homeroom?.__backendId).map(h => h.class_name).includes(c));

      const modal = document.createElement('div');
      modal.id = 'modal';
      modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-xl card-shadow w-full max-w-md mx-4 animate-fade">
          <div class="p-6 border-b"><h3 class="text-lg font-semibold text-gray-800">${isEdit ? 'Edit' : 'Tambah'} Wali Kelas</h3></div>
          <form id="homeroomForm" class="p-6 space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1" for="homeroomTeacher">Pilih Guru</label>
              <select id="homeroomTeacher" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500" required>
                <option value="">-- Pilih Guru --</option>
                ${teachers.map(t => {
                  const disabled = (!isEdit && assignedTeacherIds.includes(t.__backendId)) ? 'disabled' : '';
                  const selected = (isEdit && homeroom?.ref_teacher_id === t.__backendId) || (!isEdit && homeroom?.kode_guru && (t.kode_guru === homeroom.kode_guru || t.nip === homeroom.kode_guru)) ? 'selected' : '';
                  return `<option value="${t.__backendId}" ${disabled} ${selected}>${t.name} (${t.kode_guru || t.nip || 'no-kode'})</option>`;
                }).join('')}
              </select>
              <p class="text-xs text-gray-500 mt-1">Pilih guru yang akan menjadi wali kelas. Jika guru belum muncul, tambahkan guru terlebih dahulu.</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1" for="homeroomClass">Kelas</label>
              <select id="homeroomClass" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500" required>
                ${isEdit && homeroom?.class_name ? `<option value="${homeroom.class_name}" selected>Kelas ${homeroom.class_name}</option>` : ''}
                ${availableClasses.map(c => `<option value="${c}">Kelas ${c}</option>`).join('')}
              </select>
            </div>

            <div class="flex gap-3 pt-4">
              <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Batal</button>
              <button type="submit" class="flex-1 btn-primary text-white px-4 py-2 rounded-lg">${isEdit ? 'Simpan' : 'Tambah'}</button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      // helper: set form values when a teacher is selected
      const teacherSelect = document.getElementById('homeroomTeacher');
      function syncTeacherToForm() {
        const sel = teacherSelect.value;
        if (!sel) return;
        const t = teachers.find(x => x.__backendId === sel);
        if (!t) return;
        // populate hidden fields by keeping homeroom object fields when creating/updating
        // we will use selected teacher data on submit
      }
      teacherSelect.addEventListener('change', syncTeacherToForm);

      document.getElementById('homeroomForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const teacherId = document.getElementById('homeroomTeacher').value;
        const class_name = document.getElementById('homeroomClass').value;
        if (!teacherId) { showToast('Pilih guru untuk dijadikan wali kelas!', 'error'); return; }
        const teacher = teachers.find(t => t.__backendId === teacherId);
        if (!teacher) { showToast('Guru tidak ditemukan', 'error'); return; }
        const name = teacher.name;
        const kode_guru = teacher.kode_guru || teacher.nip || '';

        if (isEdit) {
          const result = await window.dataSdk.update({ ...homeroom, name, kode_guru, class_name, ref_teacher_id: teacher.__backendId });
          if (result && result.isOk) showToast('Data wali kelas berhasil diperbarui!');
          else showToast('Gagal memperbarui data!', 'error');
        } else {
          if (allData.length >= 999) { showToast('Batas maksimal 999 data tercapai!', 'error'); return; }
          const result = await window.dataSdk.create({ type: 'homeroom', name, kode_guru, class_name, ref_teacher_id: teacher.__backendId, created_at: new Date().toISOString() });
          if (result && result.isOk) showToast('Wali kelas berhasil ditambahkan!');
          else showToast('Gagal menambahkan wali kelas!', 'error');
        }
        closeModal();
      });
    }

    function editHomeroom(id) { const homeroom = allData.find(d => d.__backendId === id); if (homeroom) showAddHomeroomModal(homeroom); }
    async function deleteHomeroom(id) {
      const homeroom = allData.find(d => d.__backendId === id);
      if (!homeroom) return;
      showConfirmModal('Hapus Wali Kelas', `Yakin ingin menghapus wali kelas ${homeroom.name}?`, async () => {
        const result = await window.dataSdk.delete(homeroom);
        if (result.isOk) { showToast('Wali kelas berhasil dihapus!'); const account = getAccounts().find(a => a.ref_id === id); if (account) await window.dataSdk.delete(account); }
        else showToast('Gagal menghapus wali kelas!', 'error');
      });
    }

    function renderStudentsManagement(container) {
      const students = getStudents();
      // ensure default grade
      if (!currentStudentGradeTab) currentStudentGradeTab = '7';
      container.innerHTML = `
        <div class="animate-fade">
          <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Data Siswa</h1>
            <div class="flex gap-3">
              <button onclick="showBulkStudentModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v8m0 0l3-3m-3 3l-3-3M4 20h16"/></svg>
                Import Siswa
              </button>
              <button onclick="showAddStudentModal()" class="btn-primary text-white px-4 py-2 rounded-lg flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                Tambah Siswa
              </button>
            </div>
          </div>

          <!-- Grade tabs -->
          <div class="flex gap-2 mb-6">
            <button onclick="switchStudentDataGradeTab('7')" id="data-grade-tab-7" class="grade-data-tab px-6 py-3 rounded-lg font-medium text-sm transition ${currentStudentGradeTab === '7' ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">Kelas 7</button>
            <button onclick="switchStudentDataGradeTab('8')" id="data-grade-tab-8" class="grade-data-tab px-6 py-3 rounded-lg font-medium text-sm transition ${currentStudentGradeTab === '8' ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">Kelas 8</button>
            <button onclick="switchStudentDataGradeTab('9')" id="data-grade-tab-9" class="grade-data-tab px-6 py-3 rounded-lg font-medium text-sm transition ${currentStudentGradeTab === '9' ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">Kelas 9</button>
          </div>

          <div id="studentDataGradeContent"></div>
        </div>
      `;

      renderStudentsForGrade();
    }

    function filterStudents() {
      const search = document.getElementById('searchStudent')?.value.toLowerCase() || '';
      const classFilter = document.getElementById('filterClass')?.value || '';
      document.querySelectorAll('#studentsTableBody tr[data-class]').forEach(row => {
        const name = row.dataset.name || '';
        const rowClass = row.dataset.class;
        row.style.display = (name.includes(search) && (!classFilter || rowClass === classFilter)) ? '' : 'none';
      });
    }

    // --- New: per-grade student data view (Data Siswa) ---
    function switchStudentDataGradeTab(grade) {
      currentStudentGradeTab = grade;
      document.querySelectorAll('.grade-data-tab').forEach(t => {
        t.classList.remove('bg-amber-500', 'text-white');
        t.classList.add('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
      });
      const active = document.getElementById(`data-grade-tab-${grade}`);
      if (active) {
        active.classList.remove('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
        active.classList.add('bg-amber-500', 'text-white');
      }
      renderStudentsForGrade();
    }

    function renderStudentsForGrade() {
      const content = document.getElementById('studentDataGradeContent');
      if (!content) return;
      const students = getStudents();
      const grade = currentStudentGradeTab || '7';
      const gradeStudents = students.filter(s => s.class_name?.startsWith(grade));
      const gradeClasses = CLASSES.filter(c => c.startsWith(grade));

      content.innerHTML = `
        <div class="bg-white rounded-xl p-6 card-shadow mb-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div class="flex items-center gap-4">
              <div class="w-14 h-14 rounded-full bg-amber-100 flex items-center justify-center">
                <span class="text-2xl font-bold text-amber-600">${gradeStudents.length}</span>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-gray-800">Data Siswa Kelas ${grade}</h3>
                <p class="text-sm text-gray-500">${gradeStudents.length} siswa</p>
              </div>
            </div>
            <div class="flex gap-3 flex-wrap">
              ${gradeStudents.length > 0 ? `
                <button onclick="exportStudentsForGrade('${grade}')" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center gap-2 text-sm font-medium text-gray-700">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                  Export Kelas ${grade}
                </button>
              ` : ''}
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl card-shadow overflow-hidden">
          <div class="p-4 border-b flex flex-wrap items-center gap-3">
            <select id="filterStudentDataClass" class="px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-amber-500" onchange="filterStudentDataTable()">
              <option value="">Semua Kelas ${grade}</option>
              ${gradeClasses.map(c => `<option value="${c}">Kelas ${c}</option>`).join('')}
            </select>
            <input type="text" id="searchStudentData" placeholder="Cari siswa..." class="px-4 py-2 border rounded-lg text-sm w-64 focus:ring-2 focus:ring-amber-500" oninput="filterStudentDataTable()">
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">No</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Nama Lengkap</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">NIS</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Kelas</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Aksi</th>
                </tr>
              </thead>
              <tbody id="studentsDataTableBody" class="divide-y divide-gray-200">
                ${gradeStudents.length === 0 ? `<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Belum ada data siswa untuk Kelas ${grade}</td></tr>` : gradeStudents.map((s, i) => `
                  <tr class="table-row" data-class="${s.class_name}" data-name="${s.name.toLowerCase()}">
                    <td class="px-6 py-4 text-sm text-gray-600">${i + 1}</td>
                    <td class="px-6 py-4 text-sm font-medium text-gray-800">${s.name}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${s.nis}</td>
                    <td class="px-6 py-4"><span class="px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-sm font-medium">${s.class_name}</span></td>
                    <td class="px-6 py-4">
                      <div class="flex gap-2">
                        <button onclick="editStudent('${s.__backendId}')" class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg></button>
                        <button onclick="deleteStudent('${s.__backendId}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function filterStudentDataTable() {
      const search = document.getElementById('searchStudentData')?.value.toLowerCase() || '';
      const classFilter = document.getElementById('filterStudentDataClass')?.value || '';
      document.querySelectorAll('#studentsDataTableBody tr[data-class]').forEach(row => {
        const name = row.dataset.name || '';
        const rowClass = row.dataset.class;
        row.style.display = (name.includes(search) && (!classFilter || rowClass === classFilter)) ? '' : 'none';
      });
    }

    function exportStudentsForGrade(grade) {
      const students = getStudents().filter(s => s.class_name?.startsWith(grade));
      if (!students || students.length === 0) { showToast('Tidak ada data untuk diexport', 'error'); return; }
      exportToExcel(students, `data_siswa_kelas_${grade}_${new Date().toISOString().split('T')[0]}`);
    }

    function showAddStudentModal(student = null) {
      const isEdit = student !== null;
      const modal = document.createElement('div');
      modal.id = 'modal';
      modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-xl card-shadow w-full max-w-md mx-4 animate-fade">
          <div class="p-6 border-b"><h3 class="text-lg font-semibold text-gray-800">${isEdit ? 'Edit' : 'Tambah'} Siswa</h3></div>
          <form id="studentForm" class="p-6 space-y-4">
            <div><label class="block text-sm font-medium text-gray-700 mb-1" for="studentName">Nama Lengkap</label><input type="text" id="studentName" value="${student?.name || ''}" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500" required></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-1" for="studentNis">NIS</label><input type="text" id="studentNis" value="${student?.nis || ''}" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500" required></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-1" for="studentClass">Kelas</label><select id="studentClass" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500" required>${CLASSES.map(c => `<option value="${c}" ${student?.class_name === c ? 'selected' : ''}>Kelas ${c}</option>`).join('')}</select></div>
            <div class="flex gap-3 pt-4">
              <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Batal</button>
              <button type="submit" class="flex-1 btn-primary text-white px-4 py-2 rounded-lg">${isEdit ? 'Simpan' : 'Tambah'}</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById('studentForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('studentName').value;
        const nis = document.getElementById('studentNis').value;
        const class_name = document.getElementById('studentClass').value;
        if (isEdit) {
          const result = await window.dataSdk.update({ ...student, name, nis, class_name });
          if (result.isOk) showToast('Data siswa berhasil diperbarui!');
          else showToast('Gagal memperbarui data!', 'error');
        } else {
          if (allData.length >= 999) { showToast('Batas maksimal 999 data tercapai!', 'error'); return; }
          const result = await window.dataSdk.create({ type: 'student', name, nis, class_name, created_at: new Date().toISOString() });
          if (result.isOk) showToast('Siswa berhasil ditambahkan!');
          else showToast('Gagal menambahkan siswa!', 'error');
        }
        closeModal();
      });
    }

    function editStudent(id) { const student = allData.find(d => d.__backendId === id); if (student) showAddStudentModal(student); }
    async function deleteStudent(id) {
      const student = allData.find(d => d.__backendId === id);
      if (!student) return;
      showConfirmModal('Hapus Siswa', `Yakin ingin menghapus siswa ${student.name}?`, async () => {
        const result = await window.dataSdk.delete(student);
        if (result.isOk) { showToast('Siswa berhasil dihapus!'); const account = getAccounts().find(a => a.ref_id === id); if (account) await window.dataSdk.delete(account); }
        else showToast('Gagal menghapus siswa!', 'error');
      });
    }

    // --- Attendance and Grade edit/delete for homeroom users ---
    function showEditAttendanceModal(attendance = null) {
      const isEdit = attendance !== null;
      const modal = document.createElement('div');
      modal.id = 'modal';
      modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-xl card-shadow w-full max-w-md mx-4 animate-fade">
          <div class="p-6 border-b"><h3 class="text-lg font-semibold text-gray-800">${isEdit ? 'Edit' : 'Tambah'} Absensi</h3></div>
          <form id="attendanceForm" class="p-6 space-y-4">
            <div><label class="block text-sm font-medium text-gray-700 mb-1" for="attendanceDate">Tanggal</label><input type="date" id="attendanceDate" value="${isEdit ? (attendance.date || attendance.created_at).split('T')[0] : new Date().toISOString().split('T')[0]}" class="w-full px-4 py-2 border rounded-lg" required></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-1" for="attendanceSubject">Mata Pelajaran</label><input type="text" id="attendanceSubject" value="${isEdit ? (attendance.subject || '') : ''}" class="w-full px-4 py-2 border rounded-lg"></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-1" for="attendanceStatus">Status</label><select id="attendanceStatus" class="w-full px-4 py-2 border rounded-lg"><option value="hadir">Hadir</option><option value="izin">Izin</option><option value="sakit">Sakit</option><option value="alpha">Alpha</option></select></div>
            <div class="flex gap-3 pt-4">
              <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Batal</button>
              <button type="submit" class="flex-1 btn-primary text-white px-4 py-2 rounded-lg">Simpan</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
      if (isEdit) document.getElementById('attendanceStatus').value = attendance.status;
      document.getElementById('attendanceForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const date = document.getElementById('attendanceDate').value;
        const subject = document.getElementById('attendanceSubject').value.trim();
        const status = document.getElementById('attendanceStatus').value;
        if (isEdit) {
          const result = await window.dataSdk.update({ ...attendance, date, subject, status });
          if (result.isOk) showToast('Absensi berhasil diperbarui!'); else showToast('Gagal memperbarui absensi!', 'error');
        } else {
          const result = await window.dataSdk.create({ type: 'attendance', student_id: attendance?.student_id, date, subject, status, created_at: new Date().toISOString() });
          if (result.isOk) showToast('Absensi berhasil ditambahkan!'); else showToast('Gagal menambahkan absensi!', 'error');
        }
        closeModal();
      });
    }

    async function editAttendance(id) { const attendance = allData.find(d => d.__backendId === id); if (!attendance) return; if (!canEditEntry(attendance)) { showToast('Anda tidak memiliki izin untuk mengubah entri ini', 'error'); return; } showEditAttendanceModal(attendance); }
    async function deleteAttendance(id) {
      const att = allData.find(d => d.__backendId === id);
      if (!att) return;
      if (!canDeleteEntry(att)) { showToast('Hanya pembuat entri yang dapat menghapusnya', 'error'); return; }
      showConfirmModal('Hapus Absensi', `Yakin ingin menghapus absensi pada ${att.date || att.created_at}?`, async () => {
        const result = await window.dataSdk.delete(att);
        if (result.isOk) showToast('Absensi berhasil dihapus!'); else showToast('Gagal menghapus absensi!', 'error');
      });
    }

    function showEditGradeModal(grade = null) {
      const isEdit = grade !== null;
      const modal = document.createElement('div');
      modal.id = 'modal';
      modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-xl card-shadow w-full max-w-lg mx-4 animate-fade max-h-[90%] overflow-auto">
          <div class="p-6 border-b"><h3 class="text-lg font-semibold text-gray-800">${isEdit ? 'Edit' : 'Tambah'} Nilai</h3></div>
          <form id="gradeForm" class="p-6 space-y-4">
            <div><label class="block text-sm font-medium text-gray-700 mb-1" for="gradeDate">Tanggal</label><input type="date" id="gradeDate" value="${isEdit ? (grade.date || grade.created_at).split('T')[0] : new Date().toISOString().split('T')[0]}" class="w-full px-4 py-2 border rounded-lg" required></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-1" for="gradeSubject">Mata Pelajaran</label><input type="text" id="gradeSubject" value="${isEdit ? (grade.subject || '') : ''}" class="w-full px-4 py-2 border rounded-lg" required></div>
            <div class="grid grid-cols-2 gap-3">
              <div><label class="block text-sm text-gray-700">Tugas 1</label><input type="number" id="gradeTask1" value="${isEdit ? (grade.task1 || '') : ''}" class="w-full px-3 py-2 border rounded-lg"></div>
              <div><label class="block text-sm text-gray-700">Tugas 2</label><input type="number" id="gradeTask2" value="${isEdit ? (grade.task2 || '') : ''}" class="w-full px-3 py-2 border rounded-lg"></div>
              <div><label class="block text-sm text-gray-700">Tugas 3</label><input type="number" id="gradeTask3" value="${isEdit ? (grade.task3 || '') : ''}" class="w-full px-3 py-2 border rounded-lg"></div>
              <div><label class="block text-sm text-gray-700">Tugas 4</label><input type="number" id="gradeTask4" value="${isEdit ? (grade.task4 || '') : ''}" class="w-full px-3 py-2 border rounded-lg"></div>
              <div><label class="block text-sm text-gray-700">Tugas 5</label><input type="number" id="gradeTask5" value="${isEdit ? (grade.task5 || '') : ''}" class="w-full px-3 py-2 border rounded-lg"></div>
              <div><label class="block text-sm text-gray-700">Ulangan Harian</label><input type="number" id="gradeDaily" value="${isEdit ? (grade.daily_test || '') : ''}" class="w-full px-3 py-2 border rounded-lg"></div>
              <div><label class="block text-sm text-gray-700">Ujian</label><input type="number" id="gradeExam" value="${isEdit ? (grade.exam || '') : ''}" class="w-full px-3 py-2 border rounded-lg"></div>
            </div>
            <div class="flex gap-3 pt-4">
              <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Batal</button>
              <button type="submit" class="flex-1 btn-primary text-white px-4 py-2 rounded-lg">Simpan</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById('gradeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const date = document.getElementById('gradeDate').value;
        const subject = document.getElementById('gradeSubject').value.trim();
        const task1 = parseFloat(document.getElementById('gradeTask1').value) || null;
        const task2 = parseFloat(document.getElementById('gradeTask2').value) || null;
        const task3 = parseFloat(document.getElementById('gradeTask3').value) || null;
        const task4 = parseFloat(document.getElementById('gradeTask4').value) || null;
        const task5 = parseFloat(document.getElementById('gradeTask5').value) || null;
        const daily_test = parseFloat(document.getElementById('gradeDaily').value) || null;
        const exam = parseFloat(document.getElementById('gradeExam').value) || null;
        if (isEdit) {
          const result = await window.dataSdk.update({ ...grade, date, subject, task1, task2, task3, task4, task5, daily_test, exam });
          if (result.isOk) showToast('Nilai berhasil diperbarui!'); else showToast('Gagal memperbarui nilai!', 'error');
        } else {
          const result = await window.dataSdk.create({ type: 'grade', student_id: grade?.student_id, date, subject, task1, task2, task3, task4, task5, daily_test, exam, created_at: new Date().toISOString() });
          if (result.isOk) showToast('Nilai berhasil ditambahkan!'); else showToast('Gagal menambahkan nilai!', 'error');
        }
        closeModal();
      });
    }

    async function editGrade(id) { const grade = allData.find(d => d.__backendId === id); if (!grade) return; if (!canEditEntry(grade)) { showToast('Anda tidak memiliki izin untuk mengubah entri ini', 'error'); return; } showEditGradeModal(grade); }
    async function deleteGrade(id) {
      const grade = allData.find(d => d.__backendId === id);
      if (!grade) return;
      if (!canDeleteEntry(grade)) { showToast('Hanya pembuat entri yang dapat menghapusnya', 'error'); return; }
      showConfirmModal('Hapus Nilai', `Yakin ingin menghapus nilai ${grade.subject || ''} pada ${grade.date || grade.created_at}?`, async () => {
        const result = await window.dataSdk.delete(grade);
        if (result.isOk) showToast('Nilai berhasil dihapus!'); else showToast('Gagal menghapus nilai!', 'error');
      });
    }

    // --- Helpers to support teacher edit/delete in class views ---
    function setAttendanceFromRecord(studentId, status) {
      const row = document.getElementById(`att-row-${studentId}`);
      if (!row) return;
      const btns = row.querySelectorAll('.att-btn');
      btns.forEach(b => { b.classList.remove('bg-green-500','bg-blue-500','bg-amber-500','bg-red-500','text-white'); b.classList.add('bg-gray-200'); });
      const colors = { hadir: 'bg-green-500', sakit: 'bg-blue-500', izin: 'bg-amber-500', alpha: 'bg-red-500' };
      const target = Array.from(btns).find(b => ((b.textContent||b.innerText).trim().toLowerCase() === (status[0]||'').toLowerCase()) || (b.getAttribute('onclick')||'').includes(`'${status}'`));
      if (target) { target.classList.remove('bg-gray-200'); target.classList.add(colors[status], 'text-white'); }
      const statusEl = document.getElementById(`att-status-${studentId}`);
      if (statusEl) statusEl.innerHTML = `<span class="text-green-500 font-bold">âœ“</span>`;
      attendanceData[studentId] = status;
      row.classList.add('row-filled');
      updateAttendanceProgress();
    }

    function isTeacherAssignedToClass(className) {
      const myTeacher = getTeachers().find(t => t.__backendId === currentUser.id) || null;
      if (!myTeacher || !myTeacher.class_name) return false;
      const assigned = myTeacher.class_name.split(',').map(x => x.trim()).filter(x => x);
      return assigned.includes(className);
    }

    function canEditEntry(entry) {
      if (!entry) return false;
      // Creator can always edit
      if (entry.teacher_id && entry.teacher_id === currentUser.id) return true;
      // Teachers assigned to the class can edit â€” only if enabled in config
      const allowAssignedEdit = (config && config.permissions && config.permissions.assignedTeacherCanEdit) || false;
      if (allowAssignedEdit && entry.class_name && isTeacherAssignedToClass(entry.class_name)) return true;
      return false;
    }

    function canDeleteEntry(entry) {
      if (!entry) return false;
      // Admins can always delete
      if (currentUser && currentUser.role === 'admin') return true;
      // Creator may delete
      if (entry.teacher_id && entry.teacher_id === currentUser.id) return true;
      // Teachers assigned to the class may delete only if enabled in config
      const allowAssignedDelete = (config && config.permissions && config.permissions.assignedTeacherCanDelete) || false;
      if (allowAssignedDelete && entry.class_name && isTeacherAssignedToClass(entry.class_name)) return true;
      return false;
    }

    function populateAttendanceActions() {
      const selectedDate = document.getElementById('attendanceDate')?.value;
      if (!selectedDate) return;
      const rows = document.querySelectorAll('tr[id^="att-row-"]');
      rows.forEach(r => {
        const studentId = r.id.replace('att-row-','');
        const existing = getAttendance().find(a => a.student_id === studentId && a.date === selectedDate && a.subject === selectedSubject);
        const actionsCell = document.getElementById(`att-actions-${studentId}`);
        if (!actionsCell) return;
        if (existing) {
          const canEdit = canEditEntry(existing);
          const canDelete = canDeleteEntry(existing);
          if (canEdit || canDelete) {
            const editBtn = canEdit ? `<button onclick="editAttendance('${existing.__backendId}')" class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg">Edit</button>` : '';
            const delBtn = canDelete ? `<button onclick="deleteAttendance('${existing.__backendId}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">Hapus</button>` : '';
            actionsCell.innerHTML = `<div class="flex gap-2">${editBtn}${delBtn}</div>`;
          } else {
            const owner = getTeachers().find(t => t.__backendId === existing.teacher_id) || null;
            const ownerName = owner ? owner.name : 'Guru lain';
            actionsCell.innerHTML = `<div class="text-xs text-gray-500">Dibuat oleh ${ownerName}</div>`;
          }
          setAttendanceFromRecord(studentId, existing.status);
        } else {
          // allow Add only if teacher is assigned to this class
          if (isTeacherAssignedToClass(selectedClass)) {
            actionsCell.innerHTML = `<div class="flex gap-2"><button onclick="showAddAttendanceFor('${studentId}')" class="p-2 text-amber-600 hover:bg-amber-50 rounded-lg">Tambah</button></div>`;
          } else {
            actionsCell.innerHTML = `<div class="text-xs text-gray-400">Tidak dapat menambah</div>`;
          }
        }
      });
    }

    function showAddAttendanceFor(studentId) {
      const selectedDate = document.getElementById('attendanceDate')?.value;
      showEditAttendanceModal({ student_id: studentId, date: selectedDate, subject: selectedSubject });
    }

    function populateGradeActions() {
      const selectedDate = document.getElementById('gradeDate')?.value;
      const assessmentType = document.getElementById('assessmentType')?.value;
      const rows = document.querySelectorAll('tr[id^="grade-row-"]');
      rows.forEach(r => {
        const studentId = r.id.replace('grade-row-','');
        const actionsCell = document.getElementById(`grade-actions-${studentId}`);
        if (!actionsCell) return;
        const existing = getGrades().find(g => g.student_id === studentId && g.subject === selectedSubject);
        const input = document.getElementById(`grade-input-${studentId}`);
        if (existing) {
          const canEdit = canEditEntry(existing);
          const canDelete = canDeleteEntry(existing);
          const val = existing[assessmentType] ?? '';
          if (input) { input.value = (val !== null && val !== undefined) ? val : ''; if (val !== null && val !== undefined && val !== '') setGrade(studentId, val); }
          if (canEdit || canDelete) {
            const editBtn = canEdit ? `<button onclick="editGrade('${existing.__backendId}')" class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg">Edit</button>` : '';
            const delBtn = canDelete ? `<button onclick="deleteGrade('${existing.__backendId}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">Hapus</button>` : '';
            actionsCell.innerHTML = `<div class="flex gap-2 justify-center">${editBtn}${delBtn}</div>`;
            if (input) input.disabled = !canEdit;
          } else {
            const owner = getTeachers().find(t => t.__backendId === existing.teacher_id) || null;
            const ownerName = owner ? owner.name : 'Guru lain';
            actionsCell.innerHTML = `<div class="text-xs text-gray-500">Dibuat oleh ${ownerName}</div>`;
            if (input) input.disabled = true;
          }
        } else {
          // allow Add only if teacher is assigned to this class
          if (isTeacherAssignedToClass(selectedClass)) {
            actionsCell.innerHTML = `<div class="flex gap-2 justify-center"><button onclick="showAddGradeFor('${studentId}')" class="p-2 text-amber-600 hover:bg-amber-50 rounded-lg">Tambah</button></div>`;
          } else {
            actionsCell.innerHTML = `<div class="text-xs text-gray-400">Tidak dapat menambah</div>`;
          }
        }
      });
    }

    function showAddGradeFor(studentId) {
      const selectedDate = document.getElementById('gradeDate')?.value;
      showEditGradeModal({ student_id: studentId, subject: selectedSubject, date: selectedDate });
    }

    // Bulk import students (CSV/paste) -------------------------------------------------
    function splitCsvLine(line) {
      const re = /("([^"]*(""[^"]*)*)"|[^,\s]+)(?=,|$)/g;
      const res = [];
      let m;
      while ((m = re.exec(line)) !== null) {
        let v = m[0].trim();
        if (v.startsWith('"') && v.endsWith('"')) v = v.slice(1, -1).replace(/""/g, '"');
        res.push(v);
      }
      return res;
    }

    function parseCsvText(text) {
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);
      if (lines.length === 0) return [];
      // Detect header (support common variants: name, nama, nama_lengkap) and first/last name columns
      const firstParts = splitCsvLine(lines[0]).map(s => s.toLowerCase());
      const hasNameLike = firstParts.includes('name') || firstParts.includes('nama') || firstParts.includes('nama_lengkap') || firstParts.includes('full_name') || (firstParts.some(h => ['first_name','given_name','nama_depan','first','given'].includes(h)) && firstParts.some(h => ['last_name','family_name','nama_belakang','last','family'].includes(h)));
      const hasHeader = hasNameLike && (firstParts.includes('nis') || firstParts.includes('nisn'));
      const rows = [];

      // helper to normalize names (collapse extra spaces)
      function normalizeName(n) { return (n || '').replace(/\s+/g, ' ').trim(); }

      // if header present, prepare header map once
      let headerMap = null;
      if (hasHeader) {
        const headers = splitCsvLine(lines[0]).map(p => p.toLowerCase());
        headerMap = {
          name: headers.findIndex(h => ['name','nama','nama_lengkap','full_name'].includes(h)),
          first_name: headers.findIndex(h => ['first_name','given_name','nama_depan','first','given'].includes(h)),
          last_name: headers.findIndex(h => ['last_name','family_name','nama_belakang','last','family'].includes(h)),
          nis: headers.findIndex(h => ['nis','nisn'].includes(h)),
          class_name: headers.findIndex(h => ['class_name','class','kelas','kelas_name'].includes(h))
        };
      }

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const parts = splitCsvLine(line);
        let name = '', nis = '', class_name = '';

        if (i === 0 && hasHeader) {
          // skip header row
          continue;
        }

        if (hasHeader && headerMap) {
          const vals = parts;
          if (headerMap.name !== -1) {
            name = vals[headerMap.name] || '';
          } else {
            // combine first + last if present
            const f = (headerMap.first_name !== -1) ? (vals[headerMap.first_name] || '') : '';
            const l = (headerMap.last_name !== -1) ? (vals[headerMap.last_name] || '') : '';
            if (f || l) name = (f + ' ' + l).trim();
            else name = '';
          }
          if (headerMap.nis !== -1) nis = vals[headerMap.nis] || '';
          if (headerMap.class_name !== -1) class_name = vals[headerMap.class_name] || '';
        } else {
          // assume order: name,nis,class
          name = parts[0] || '';
          nis = parts[1] || '';
          class_name = parts[2] || '';
        }

        rows.push({ name: normalizeName(name), nis: (nis || '').trim(), class_name: (class_name || '').replace(/\s+/g,'').toUpperCase(), line: i + 1 });
      }
      return rows;
    }

    function validateImportRows(rows) {
      const existingNis = getStudents().map(s => s.nis);
      return rows.map(r => {
        const errors = [];
        if (!r.name) errors.push('Nama kosong');
        if (!r.nis) errors.push('NIS kosong');
        if (existingNis.includes(r.nis)) errors.push('NIS sudah ada');
        if (!r.class_name) errors.push('Kelas kosong');
        else if (!CLASSES.includes(r.class_name)) errors.push('Kelas tidak valid');
        return { ...r, errors };
      });
    }

    function buildImportPreviewHtml(validated) {
      if (!validated || validated.length === 0) return '<div class="p-4 text-sm text-gray-500">Tidak ada data untuk ditampilkan</div>';
      return `
        <table class="w-full text-sm">
          <thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left">Baris</th><th class="px-3 py-2 text-left">Nama Lengkap</th><th class="px-3 py-2 text-left">NIS</th><th class="px-3 py-2 text-left">Kelas</th><th class="px-3 py-2 text-left">Status</th></tr></thead>
          <tbody class="divide-y">${validated.map(r => `
            <tr><td class="px-3 py-2">${r.line}</td><td class="px-3 py-2">${r.name}</td><td class="px-3 py-2 font-mono">${r.nis}</td><td class="px-3 py-2">${r.class_name}</td><td class="px-3 py-2">${r.errors.length === 0 ? '<span class="text-green-600">OK</span>' : '<span class="text-red-600">'+ r.errors.join(', ') +'</span>'}</td></tr>
          `).join('')}</tbody>
        </table>
      `;
    }

    function showBulkStudentModal() {
      const modal = document.createElement('div');
      modal.id = 'modal';
      modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-xl card-shadow w-full max-w-2xl mx-4 animate-fade">
          <div class="p-6 border-b"><h3 class="text-lg font-semibold text-gray-800">Import Siswa (CSV)</h3></div>
          <div class="p-6 space-y-4">
            <p class="text-sm text-gray-600">Unggah file CSV/Excel dengan kolom <code>nama/nama_lengkap (atau name), nis, class_name</code>, atau paste CSV ke area. Kolom <code>class_name</code> harus sesuai format (mis. <code>7A</code>, <code>8B</code>).</p>
            <div class="grid md:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm text-gray-600 mb-1">File CSV / Excel (.xlsx)</label>
                <input type="file" id="importStudentsFile" accept=".csv,.xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" class="w-full">
                <button id="downloadTemplateBtn" class="mt-2 px-3 py-2 border border-gray-300 rounded-lg text-sm">Unduh Template</button>
              </div>
              <div>
                <label class="block text-sm text-gray-600 mb-1">Atau Paste CSV</label>
                <textarea id="importStudentsPaste" rows="6" class="w-full px-3 py-2 border rounded-lg" placeholder="Nama,NIS,Kelas"></textarea>
              </div>
            </div>

            <div>
              <label class="flex items-center gap-2"><input type="checkbox" id="importCreateAccounts"> <span class="text-sm">Buat akun siswa otomatis untuk yang belum punya</span></label>
            </div>

            <div>
              <div id="importPreview" class="max-h-64 overflow-auto border rounded-lg"></div>
            </div>

            <div class="flex gap-3 justify-end pt-2">
              <button type="button" onclick="closeModal()" class="px-4 py-2 border border-gray-300 rounded-lg">Batal</button>
              <button id="importExecuteBtn" type="button" disabled class="px-4 py-2 bg-amber-500 text-white rounded-lg">Impor</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      const fileInput = document.getElementById('importStudentsFile');
      const paste = document.getElementById('importStudentsPaste');
      const preview = document.getElementById('importPreview');
      const importBtn = document.getElementById('importExecuteBtn');
      const templateBtn = document.getElementById('downloadTemplateBtn');

      function updatePreviewFromText(txt) {
        const rows = parseCsvText(txt);
        const validated = validateImportRows(rows);
        preview.innerHTML = buildImportPreviewHtml(validated);
        const anyValid = validated.some(r => r.errors.length === 0);
        importBtn.disabled = !anyValid;
        return validated;
      }

      fileInput.addEventListener('change', async (e) => {
        const f = e.target.files && e.target.files[0];
        if (!f) return;
        const name = (f.name || '').toLowerCase();
        // Excel (.xlsx, .xls)
        if (name.endsWith('.xlsx') || name.endsWith('.xls')) {
          if (!window.XLSX) { showToast('Library XLSX tidak tersedia. Gunakan CSV.', 'error'); return; }
          try {
            const ab = await f.arrayBuffer();
            const wb = XLSX.read(ab, { type: 'array' });
            const wsName = wb.SheetNames[0];
            const ws = wb.Sheets[wsName];
            const arr = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' }); // array of arrays
            const lines = arr.map(row => row.map(cell => {
              let s = (cell === null || cell === undefined) ? '' : String(cell);
              if (s.indexOf(',') !== -1 || s.indexOf('"') !== -1) s = '"' + s.replace(/"/g, '""') + '"';
              return s;
            }).join(','));
            paste.value = lines.join('\n');
            updatePreviewFromText(paste.value);
          } catch (err) {
            console.error('Failed to parse Excel', err);
            showToast('Gagal membaca file Excel', 'error');
          }
        } else {
          const txt = await f.text();
          paste.value = txt;
          updatePreviewFromText(txt);
        }
      });

      paste.addEventListener('input', (e) => updatePreviewFromText(e.target.value));

      templateBtn.addEventListener('click', () => {
        const csv = 'nama,nis,class_name\n"Nama Lengkap Siswa 1",12345,7A\n"Nama Lengkap Siswa Dua",12346,8B\n';
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'template_siswa.csv'; document.body.appendChild(a); a.click(); a.remove();
      });

      importBtn.addEventListener('click', async () => {
        const txt = paste.value || '';
        const validated = validateImportRows(parseCsvText(txt));
        const toCreate = validated.filter(r => r.errors.length === 0);
        if (toCreate.length === 0) { showToast('Tidak ada baris valid untuk diimpor', 'error'); return; }
        const createAccounts = document.getElementById('importCreateAccounts').checked;

        showConfirmModal('Konfirmasi Impor', `Impor ${toCreate.length} siswa?`, async () => {
          let created = 0;
          for (const r of toCreate) {
            if (allData.length >= 999) { showToast('Batas maksimal 999 data tercapai!', 'error'); break; }
            const res = await window.dataSdk.create({ type: 'student', name: r.name, nis: r.nis, class_name: r.class_name, created_at: new Date().toISOString() }).catch(e => ({ isOk: false, error: e }));
            if (res && res.isOk) {
              created++;
              if (createAccounts) {
                const s = getStudents().find(st => st.nis === r.nis && st.name === r.name);
                if (s) {
                  const existing = getAccounts().find(a => a.ref_id === s.__backendId && a.role === 'student');
                  if (!existing) {
                    const username = s.nis || generateId().substr(0,8);
                    const password = s.nis || generateId().substr(0,8);
                    await window.dataSdk.create({ type: 'account', name: s.name, username, password, role: 'student', ref_id: s.__backendId, class_name: s.class_name || '', created_at: new Date().toISOString() });
                  }
                }
              }
            }
          }
          await window.dataSdk.getAll().then(res => { if (res && res.isOk) allData = res.data; });
          showToast(`Impor selesai. ${created} siswa dibuat.`);
          closeModal();
          setAdminView('students');
        });
      });
    }

    // ==================== ACCOUNTS MANAGEMENT ====================
    let currentAccountTab = 'teacher';
    let currentStudentGradeTab = '7';

    function renderAccountsManagement(container) {
      const accounts = getAccounts();
      const teachers = getTeachers();
      const homerooms = getHomerooms();
      const students = getStudents();
      
      const teacherAccounts = accounts.filter(a => a.role === 'teacher');
      const homeroomAccounts = accounts.filter(a => a.role === 'homeroom');
      const studentAccounts = accounts.filter(a => a.role === 'student');
      
      container.innerHTML = `
        <div class="animate-fade">
          <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Kelola Akun</h1>
          </div>
          
          <div class="flex border-b border-gray-200 mb-6">
            <button onclick="switchAccountTab('teacher')" id="tab-teacher" class="account-tab flex items-center gap-2 px-6 py-3 font-medium text-sm border-b-2 transition ${currentAccountTab === 'teacher' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
              Akun Guru
              <span class="px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-700">${teacherAccounts.length}/${teachers.length}</span>
            </button>
            <button onclick="switchAccountTab('homeroom')" id="tab-homeroom" class="account-tab flex items-center gap-2 px-6 py-3 font-medium text-sm border-b-2 transition ${currentAccountTab === 'homeroom' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700'}">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5"/></svg>
              Akun Wali Kelas
              <span class="px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-700">${homeroomAccounts.length}/${homerooms.length}</span>
            </button>
            <button onclick="switchAccountTab('student')" id="tab-student" class="account-tab flex items-center gap-2 px-6 py-3 font-medium text-sm border-b-2 transition ${currentAccountTab === 'student' ? 'border-amber-500 text-amber-600' : 'border-transparent text-gray-500 hover:text-gray-700'}">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
              Akun Siswa
              <span class="px-2 py-0.5 text-xs rounded-full bg-amber-100 text-amber-700">${studentAccounts.length}/${students.length}</span>
            </button>
          </div>
          
          <div id="accountTabContent"></div>
        </div>
      `;
      renderAccountTabContent();
    }

    function switchAccountTab(tab) {
      currentAccountTab = tab;
      if (tab === 'student') currentStudentGradeTab = '7';
      
      document.querySelectorAll('.account-tab').forEach(t => {
        t.classList.remove('border-blue-500', 'text-blue-600', 'border-green-500', 'text-green-600', 'border-amber-500', 'text-amber-600');
        t.classList.add('border-transparent', 'text-gray-500');
      });
      
      const activeTab = document.getElementById(`tab-${tab}`);
      activeTab.classList.remove('border-transparent', 'text-gray-500');
      
      const colors = { teacher: ['border-blue-500', 'text-blue-600'], homeroom: ['border-green-500', 'text-green-600'], student: ['border-amber-500', 'text-amber-600'] };
      activeTab.classList.add(...colors[tab]);
      
      renderAccountTabContent();
    }

    function switchStudentGradeTab(grade) {
      currentStudentGradeTab = grade;
      
      document.querySelectorAll('.grade-tab').forEach(t => {
        t.classList.remove('bg-amber-500', 'text-white');
        t.classList.add('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
      });
      
      const activeTab = document.getElementById(`grade-tab-${grade}`);
      if (activeTab) {
        activeTab.classList.remove('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
        activeTab.classList.add('bg-amber-500', 'text-white');
      }
      
      renderStudentAccountsForGrade();
    }

    function renderAccountTabContent() {
      const content = document.getElementById('accountTabContent');
      if (!content) return;
      
      if (currentAccountTab === 'student') {
        renderStudentAccountsWithGrades(content);
      } else {
        renderNonStudentAccounts(content);
      }
    }

    function renderStudentAccountsWithGrades(content) {
      const accounts = getAccounts();
      const students = getStudents();
      
      const grade7Students = students.filter(s => s.class_name?.startsWith('7'));
      const grade8Students = students.filter(s => s.class_name?.startsWith('8'));
      const grade9Students = students.filter(s => s.class_name?.startsWith('9'));
      
      const grade7Accounts = accounts.filter(a => a.role === 'student' && a.class_name?.startsWith('7'));
      const grade8Accounts = accounts.filter(a => a.role === 'student' && a.class_name?.startsWith('8'));
      const grade9Accounts = accounts.filter(a => a.role === 'student' && a.class_name?.startsWith('9'));
      
      content.innerHTML = `
        <!-- Grade Sub-tabs -->
        <div class="flex gap-2 mb-6">
          <button onclick="switchStudentGradeTab('7')" id="grade-tab-7" class="grade-tab px-6 py-3 rounded-lg font-medium text-sm transition flex items-center gap-2 ${currentStudentGradeTab === '7' ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
            <span class="text-lg">ðŸ“š</span> Kelas 7
            <span class="px-2 py-0.5 text-xs rounded-full ${currentStudentGradeTab === '7' ? 'bg-white/20' : 'bg-amber-100 text-amber-700'}">${grade7Accounts.length}/${grade7Students.length}</span>
          </button>
          <button onclick="switchStudentGradeTab('8')" id="grade-tab-8" class="grade-tab px-6 py-3 rounded-lg font-medium text-sm transition flex items-center gap-2 ${currentStudentGradeTab === '8' ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
            <span class="text-lg">ðŸ“–</span> Kelas 8
            <span class="px-2 py-0.5 text-xs rounded-full ${currentStudentGradeTab === '8' ? 'bg-white/20' : 'bg-amber-100 text-amber-700'}">${grade8Accounts.length}/${grade8Students.length}</span>
          </button>
          <button onclick="switchStudentGradeTab('9')" id="grade-tab-9" class="grade-tab px-6 py-3 rounded-lg font-medium text-sm transition flex items-center gap-2 ${currentStudentGradeTab === '9' ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
            <span class="text-lg">ðŸŽ“</span> Kelas 9
            <span class="px-2 py-0.5 text-xs rounded-full ${currentStudentGradeTab === '9' ? 'bg-white/20' : 'bg-amber-100 text-amber-700'}">${grade9Accounts.length}/${grade9Students.length}</span>
          </button>
        </div>
        
        <div id="studentGradeContent"></div>
      `;
      
      renderStudentAccountsForGrade();
    }

    function renderStudentAccountsForGrade() {
      const gradeContent = document.getElementById('studentGradeContent');
      if (!gradeContent) return;
      
      const accounts = getAccounts();
      const students = getStudents();
      const grade = currentStudentGradeTab;
      
      const gradeStudents = students.filter(s => s.class_name?.startsWith(grade));
      const gradeAccounts = accounts.filter(a => a.role === 'student' && a.class_name?.startsWith(grade));
      const missingCount = gradeStudents.length - gradeAccounts.length;
      
      // Get unique classes for this grade
      const gradeClasses = CLASSES.filter(c => c.startsWith(grade));
      
      gradeContent.innerHTML = `
        <!-- Summary Card -->
        <div class="bg-white rounded-xl p-6 card-shadow mb-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div class="flex items-center gap-4">
              <div class="w-14 h-14 rounded-full bg-amber-100 flex items-center justify-center">
                <span class="text-2xl font-bold text-amber-600">${gradeAccounts.length}</span>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-gray-800">Akun Siswa Kelas ${grade}</h3>
                <p class="text-sm text-gray-500">${gradeAccounts.length} dari ${gradeStudents.length} siswa kelas ${grade} sudah memiliki akun</p>
              </div>
            </div>
            <div class="flex gap-3 flex-wrap">
              ${missingCount > 0 ? `
                <button onclick="generateAccountsForGrade('${grade}')" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                  Buat ${missingCount} Akun Baru
                </button>
              ` : `
                <span class="px-4 py-2 bg-green-100 text-green-700 rounded-lg text-sm font-medium flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                  Semua Akun Sudah Dibuat
                </span>
              `}
              ${gradeAccounts.length > 0 ? `
                <button onclick="exportAccountsForGrade('${grade}')" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center gap-2 text-sm font-medium text-gray-700">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                  Export Kelas ${grade}
                </button>
              ` : ''}
            </div>
          </div>
        </div>
        
        <!-- Class Filter & Search -->
        <div class="bg-white rounded-xl card-shadow overflow-hidden">
          <div class="p-4 border-b flex flex-wrap items-center gap-3">
            <select id="filterStudentClass" class="px-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-amber-500" onchange="filterStudentAccountsTable()">
              <option value="">Semua Kelas ${grade}</option>
              ${gradeClasses.map(c => `<option value="${c}">Kelas ${c}</option>`).join('')}
            </select>
            <input type="text" id="searchStudentAccount" placeholder="Cari nama atau username..." class="px-4 py-2 border rounded-lg text-sm w-64 focus:ring-2 focus:ring-amber-500" oninput="filterStudentAccountsTable()">
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">No</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Nama Lengkap</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Kelas</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Username</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Password</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Aksi</th>
                </tr>
              </thead>
              <tbody id="studentAccountsTableBody" class="divide-y divide-gray-200">
                ${gradeAccounts.length === 0 ? `
                  <tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">
                    <div class="flex flex-col items-center gap-2">
                      <svg class="w-12 h-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>
                      <p>Belum ada akun siswa kelas ${grade}</p>
                      ${gradeStudents.length > 0 ? `<p class="text-sm">Klik tombol "Buat Akun Baru" untuk membuat akun</p>` : ''}
                    </div>
                  </td></tr>
                ` : gradeAccounts.sort((a, b) => (a.class_name || '').localeCompare(b.class_name || '') || a.name.localeCompare(b.name)).map((a, i) => `
                  <tr class="table-row student-account-row" data-name="${a.name.toLowerCase()}" data-username="${a.username.toLowerCase()}" data-class="${a.class_name}">
                    <td class="px-6 py-4 text-sm text-gray-600">${i + 1}</td>
                    <td class="px-6 py-4 text-sm font-medium text-gray-800">${a.name}</td>
                    <td class="px-6 py-4"><span class="px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-sm font-medium">${a.class_name}</span></td>
                    <td class="px-6 py-4 text-sm text-gray-600 font-mono bg-gray-50">${a.username}</td>
                    <td class="px-6 py-4 text-sm text-gray-600 font-mono bg-gray-50 pw-cell"><span class="pw-text">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span> <button onclick="revealPassword('${a.__backendId}', this)" class="ml-2 px-2 py-1 rounded bg-white/20 hover:bg-white/30 text-xs">Lihat</button></td>
                    <td class="px-6 py-4">
                      <div class="flex gap-2">
                        <button onclick="editAccount('${a.__backendId}')" class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg" title="Edit">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                        </button>
                        <button onclick="deleteAccount('${a.__backendId}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg" title="Hapus">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        </button>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function filterStudentAccountsTable() {
      const search = document.getElementById('searchStudentAccount')?.value.toLowerCase() || '';
      const classFilter = document.getElementById('filterStudentClass')?.value || '';
      
      document.querySelectorAll('.student-account-row').forEach(row => {
        const name = row.dataset.name || '';
        const username = row.dataset.username || '';
        const rowClass = row.dataset.class || '';
        const matchSearch = name.includes(search) || username.includes(search);
        const matchClass = !classFilter || rowClass === classFilter;
        row.style.display = (matchSearch && matchClass) ? '' : 'none';
      });
    }

    async function generateAccountsForGrade(grade) {
      const students = getStudents().filter(s => s.class_name?.startsWith(grade));
      const existingRefIds = getAccounts().filter(a => a.role === 'student').map(a => a.ref_id);
      const newStudents = students.filter(s => !existingRefIds.includes(s.__backendId));
      
      if (newStudents.length === 0) { showToast('Semua akun sudah dibuat!', 'error'); return; }
      
      let created = 0;
      for (const student of newStudents) {
        if (allData.length >= 999) { showToast('Batas maksimal 999 data tercapai!', 'error'); break; }
        const username = student.nis;
        const password = generateId().substr(0, 8);
        await window.dataSdk.create({ type: 'account', name: student.name, username, password, role: 'student', ref_id: student.__backendId, class_name: student.class_name || '', created_at: new Date().toISOString() });
        created++;
      }
      showToast(`${created} akun siswa kelas ${grade} berhasil dibuat!`);
    }

    function exportAccountsForGrade(grade) {
      const accounts = getAccounts().filter(a => a.role === 'student' && a.class_name?.startsWith(grade));
      exportToExcel(accounts.sort((a, b) => (a.class_name || '').localeCompare(b.class_name || '') || a.name.localeCompare(b.name)).map((a, i) => ({
        No: i + 1,
        'Nama Lengkap': a.name,
        Kelas: a.class_name || '-',
        Username: a.username,
        Password: a.password
      })), `Akun_Siswa_Kelas_${grade}`);
    }

    function renderNonStudentAccounts(content) {
      const accounts = getAccounts();
      const teachers = getTeachers();
      const homerooms = getHomerooms();
      
      let filteredAccounts = [];
      let totalItems = 0;
      let roleLabel = '';
      let roleColor = '';
      let btnColor = '';
      let headerInfo = '';
      
      if (currentAccountTab === 'teacher') {
        filteredAccounts = accounts.filter(a => a.role === 'teacher');
        totalItems = teachers.length;
        roleLabel = 'Guru';
        roleColor = 'blue';
        btnColor = 'bg-blue-500 hover:bg-blue-600';
        headerInfo = 'Kode Guru';
      } else {
        filteredAccounts = accounts.filter(a => a.role === 'homeroom');
        totalItems = homerooms.length;
        roleLabel = 'Wali Kelas';
        roleColor = 'green';
        btnColor = 'bg-green-500 hover:bg-green-600';
        headerInfo = 'Kelas';
      }
      
      const missingCount = totalItems - filteredAccounts.length;
      
      content.innerHTML = `
        <div class="bg-white rounded-xl p-6 card-shadow mb-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div class="flex items-center gap-4">
              <div class="w-14 h-14 rounded-full bg-${roleColor}-100 flex items-center justify-center">
                <span class="text-2xl font-bold text-${roleColor}-600">${filteredAccounts.length}</span>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-gray-800">Akun ${roleLabel}</h3>
                <p class="text-sm text-gray-500">${filteredAccounts.length} dari ${totalItems} ${roleLabel.toLowerCase()} sudah memiliki akun</p>
              </div>
            </div>
            <div class="flex gap-3">
              ${missingCount > 0 ? `
                <button onclick="generateAccountsFor('${currentAccountTab}')" class="${btnColor} text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                  Buat ${missingCount} Akun Baru
                </button>
              ` : `
                <span class="px-4 py-2 bg-green-100 text-green-700 rounded-lg text-sm font-medium flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                  Semua Akun Sudah Dibuat
                </span>
              `}
              ${filteredAccounts.length > 0 ? `
                <button onclick="exportAccountsToExcel('${currentAccountTab}')" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center gap-2 text-sm font-medium text-gray-700">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                  Export
                </button>
              ` : ''}
            </div>
          </div>
        </div>
        
        <div class="bg-white rounded-xl card-shadow overflow-hidden">
          <div class="p-4 border-b flex items-center justify-between">
            <h4 class="font-medium text-gray-700">Daftar Akun ${roleLabel}</h4>
            <input type="text" id="searchAccount" placeholder="Cari nama atau username..." class="px-4 py-2 border rounded-lg text-sm w-64 focus:ring-2 focus:ring-${roleColor}-500" oninput="filterAccountsTable()">
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">No</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Nama</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">${headerInfo}</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Username</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Password</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Aksi</th>
                </tr>
              </thead>
              <tbody id="accountsTableBody" class="divide-y divide-gray-200">
                ${filteredAccounts.length === 0 ? `
                  <tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">
                    <div class="flex flex-col items-center gap-2">
                      <svg class="w-12 h-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>
                      <p>Belum ada akun ${roleLabel.toLowerCase()}</p>
                      ${totalItems > 0 ? `<p class="text-sm">Klik tombol "Buat Akun Baru" untuk membuat akun</p>` : ''}
                    </div>
                  </td></tr>
                ` : filteredAccounts.map((a, i) => {
                  let infoValue = '';
                  if (currentAccountTab === 'teacher') {
                    const teacher = teachers.find(t => t.__backendId === a.ref_id);
                    infoValue = teacher?.kode_guru || teacher?.nip || a.username;
                  } else {
                    infoValue = a.class_name || '-';
                  }
                  return `
                    <tr class="table-row account-row" data-name="${a.name.toLowerCase()}" data-username="${a.username.toLowerCase()}">
                      <td class="px-6 py-4 text-sm text-gray-600">${i + 1}</td>
                      <td class="px-6 py-4 text-sm font-medium text-gray-800">${a.name}</td>
                      <td class="px-6 py-4 text-sm text-gray-600">${infoValue}</td>
                      <td class="px-6 py-4 text-sm text-gray-600 font-mono bg-gray-50">${a.username}</td>
                      <td class="px-6 py-4 text-sm text-gray-600 font-mono bg-gray-50 pw-cell"><span class="pw-text">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span> <button onclick="revealPassword('${a.__backendId}', this)" class="ml-2 px-2 py-1 rounded bg-white/20 hover:bg-white/30 text-xs">Lihat</button></td>
                      <td class="px-6 py-4">
                        <div class="flex gap-2">
                          <button onclick="editAccount('${a.__backendId}')" class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg" title="Edit">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                          </button>
                          <button onclick="changeAccountPassword('${a.__backendId}')" class="p-2 text-amber-600 hover:bg-amber-50 rounded-lg" title="Ganti Password">
                            ðŸ”‘
                          </button>
                          <button onclick="deleteAccount('${a.__backendId}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg" title="Hapus">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                          </button>
                        </div>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function filterAccountsTable() {
      const search = document.getElementById('searchAccount')?.value.toLowerCase() || '';
      document.querySelectorAll('.account-row').forEach(row => {
        const name = row.dataset.name || '';
        const username = row.dataset.username || '';
        row.style.display = (name.includes(search) || username.includes(search)) ? '' : 'none';
      });
    }

    function exportAccountsToExcel(role) {
      const accounts = getAccounts().filter(a => a.role === role);
      const roleLabels = { teacher: 'Guru', homeroom: 'Wali_Kelas' };
      exportToExcel(accounts.map((a, i) => ({
        No: i + 1,
        'Nama Lengkap': a.name,
        Username: a.username,
        Password: a.password,
        Kelas: a.class_name || '-'
      })), `Akun_${roleLabels[role]}`);
    }

    async function generateAccountsFor(role) {
      let items = [];
      if (role === 'teacher') items = getTeachers();
      else if (role === 'homeroom') items = getHomerooms();
      
      const existingRefIds = getAccounts().filter(a => a.role === role).map(a => a.ref_id);
      const newItems = items.filter(i => !existingRefIds.includes(i.__backendId));
      
      if (newItems.length === 0) { showToast('Semua akun sudah dibuat!', 'error'); return; }
      
      for (const item of newItems) {
        if (allData.length >= 999) { showToast('Batas maksimal 999 data tercapai!', 'error'); break; }
        const username = item.kode_guru || item.nip || (item.name.toLowerCase().replace(/\s+/g,'').slice(0,8) + Math.floor(Math.random()*1000));
        const password = generateId().substr(0, 8);
        await window.dataSdk.create({ type: 'account', name: item.name, username, password, role, ref_id: item.__backendId, class_name: item.class_name || '', subject: item.subject || '', created_at: new Date().toISOString() });
      }
      showToast(`${newItems.length} akun berhasil dibuat!`);
    }

    function editAccount(id) {
      const account = allData.find(d => d.__backendId === id);
      if (!account) return;
      const modal = document.createElement('div');
      modal.id = 'modal';
      modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-xl card-shadow w-full max-w-md mx-4 animate-fade">
          <div class="p-6 border-b"><h3 class="text-lg font-semibold text-gray-800">Edit Akun</h3></div>
          <form id="editAccountForm" class="p-6 space-y-4">
            <div><label class="block text-sm font-medium text-gray-700 mb-1">Nama</label><input type="text" class="w-full px-4 py-2 border rounded-lg bg-gray-100" value="${account.name}" disabled></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-1" for="editUsername">Username</label><input type="text" id="editUsername" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500" value="${account.username}" required></div>

            ${account.role === 'student' ? `
            <div class="flex items-center gap-3">
              <label class="inline-flex items-center gap-2">
                <input type="checkbox" id="editChangePassword" class="form-checkbox h-4 w-4 text-amber-500">
                <span class="text-sm text-gray-700">Ubah Password</span>
              </label>
              <span class="text-xs text-gray-400">(centang untuk mengubah password)</span>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1" for="editPassword">Password <span class="text-xs text-gray-400">(Kosongkan jika tidak ingin mengubah password)</span></label>
              <div class="flex gap-2 items-center">
                <div class="relative flex-1">
                  <input type="password" id="editPassword" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500" placeholder="Kosongkan jika tidak ingin mengubah password">
                  <button type="button" id="toggleEditPwVis" class="absolute right-2 top-1/2 -translate-y-1/2 text-sm bg-transparent px-2" aria-label="toggle visibility">ðŸ‘ï¸</button>
                </div>
                <button type="button" id="generateEditPw" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm">ðŸ”„</button>
              </div>
            </div>
            ` : `
            <div class="bg-yellow-50 border-l-4 border-yellow-300 p-3 rounded text-sm text-yellow-800">
              Untuk mengganti password, gunakan tombol <strong>ðŸ”‘ Ganti Password</strong> pada baris akun.
            </div>
            `}

            <div class="flex gap-3 pt-4">
              <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Batal</button>
              <button type="submit" class="flex-1 btn-primary text-white px-4 py-2 rounded-lg">Simpan</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);

      // wire up toggle and generate buttons (only if password controls exist â€” students)
      const changePwCheckbox = document.getElementById('editChangePassword');
      const pwInput = document.getElementById('editPassword');
      const genBtn = document.getElementById('generateEditPw');
      const toggleBtn = document.getElementById('toggleEditPwVis');

      if (pwInput) {
        // Typing into the password field implies intent to change password
        pwInput.addEventListener('input', () => {
          const has = pwInput.value.trim().length > 0;
          if (has && changePwCheckbox) changePwCheckbox.checked = true;
        });

        // checkbox now only indicates intent; it doesn't disable input
        if (changePwCheckbox) {
          changePwCheckbox.addEventListener('change', () => {
            if (!changePwCheckbox.checked && pwInput.value.trim().length === 0) {
              // nothing set
            }
          });
        }

        if (genBtn) genBtn.addEventListener('click', () => { pwInput.value = generateId().substr(0,8); if (changePwCheckbox) changePwCheckbox.checked = true; pwInput.focus(); });
        if (toggleBtn) toggleBtn.addEventListener('click', () => { if (pwInput.type === 'password') { pwInput.type = 'text'; toggleBtn.textContent = 'ðŸ™ˆ'; } else { pwInput.type = 'password'; toggleBtn.textContent = 'ðŸ‘ï¸'; } });
      }

      document.getElementById('editAccountForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('editUsername').value.trim();
        const pwEl = document.getElementById('editPassword');
        const password = pwEl ? pwEl.value.trim() : '';
        // allow either checking the box or typing a password to indicate intent
        const changePassword = (document.getElementById('editChangePassword')?.checked) || (password.length > 0);

        if (changePassword && (!password || password.length < 6)) { showToast('Password minimal 6 karakter!', 'error'); return; }
        const existingUsername = getAccounts().find(a => a.username === username && a.__backendId !== id);
        if (existingUsername) { showToast('Username sudah digunakan!', 'error'); return; }
        const payload = { ...account, username };
        if (changePassword && password) payload.password = password;

        const result = await window.dataSdk.update(payload);
        if (result.isOk) {
          // refresh client cache
          try {
            const allRes = await window.dataSdk.getAll();
            if (allRes && allRes.isOk) allData = allRes.data;
          } catch (err) { console.warn('Failed to refresh data after account update', err); }

          // verify persistence: ensure stored record matches submitted fields
          try {
            const persisted = allData.find(d => d.__backendId === account.__backendId);
            console.log('Account updated:', result.data);
            console.log('Persisted record after update:', persisted);
            console.log('Stored data snapshot:', localStorage.getItem('absensi_data_v1'));

            if (!persisted) {
              showToast('Gagal menemukan data yang tersimpan. Silakan coba lagi.', 'error');
              return;
            }

            if (persisted.username !== username) {
              showToast('Perubahan username gagal tersimpan. Silakan coba lagi.', 'error');
              return;
            }

            if (changePassword) {
              if (!password) {
                showToast('Silakan masukkan password baru atau batalkan perubahan password.', 'error');
                return;
              }
              // allow duplicate passwords across accounts â€” do not fail the save if another account has the same password
              if (persisted.password !== password) {
                console.warn('Password mismatch after update (non-blocking):', { submitted: password, persisted });
                // still proceed as update reported success; some backends might transform passwords (hashing) so strict match may not be possible
              }
            }
          } catch (err) {
            console.warn('Verification check failed', err);
          }

          showToast('Akun berhasil diperbarui!');
          closeModal();
          renderAccountsManagement(document.getElementById('accountTabContent'));
        } else showToast('Gagal memperbarui akun!', 'error');
      });
    }

    async function deleteAccount(id) {
      const account = allData.find(d => d.__backendId === id);
      if (!account) return;
      showConfirmModal('Hapus Akun', `Yakin ingin menghapus akun ${account.username}?`, async () => {
        const result = await window.dataSdk.delete(account);
        if (result.isOk) showToast('Akun berhasil dihapus!');
        else showToast('Gagal menghapus akun!', 'error');
      });
    }

    // Reveal or hide password in table (toggle)
    function revealPassword(accountId, btn) {
      try {
        const row = btn.closest('tr');
        const cell = row.querySelector('.pw-cell');
        const span = cell.querySelector('.pw-text');
        const account = allData.find(d => d.__backendId === accountId);
        if (!account) return;
        if (btn.dataset.revealed === '1') {
          span.textContent = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
          btn.textContent = 'Lihat';
          btn.dataset.revealed = '0';
        } else {
          span.textContent = account.password || '-';
          btn.textContent = 'Sembunyikan';
          btn.dataset.revealed = '1';
        }
      } catch (err) { console.error(err); }
    }

    // Quick password-change modal (only updates password)
    function changeAccountPassword(id) {
      const account = allData.find(d => d.__backendId === id);
      if (!account) return;
      const modal = document.createElement('div');
      modal.id = 'modal';
      modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-xl card-shadow w-full max-w-md mx-4 animate-fade">
          <div class="p-6 border-b"><h3 class="text-lg font-semibold text-gray-800">Ganti Password - ${account.name}</h3></div>
          <form id="changePwForm" class="p-6 space-y-4">
            <div><label class="block text-sm font-medium text-gray-700 mb-1">Username</label><input type="text" class="w-full px-4 py-2 border rounded-lg bg-gray-100" value="${account.username}" disabled></div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Password Baru</label>
              <div class="flex gap-2 items-center">
                <div class="relative flex-1">
                  <input type="password" id="newAccountPassword" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500" placeholder="Masukkan password baru (min 6)" required>
                  <button type="button" id="toggleNewPwVis" class="absolute right-2 top-1/2 -translate-y-1/2 text-sm bg-transparent px-2">ðŸ‘ï¸</button>
                </div>
                <button type="button" id="generateNewPw" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm">ðŸ”„</button>
              </div>
            </div>

            <div class="flex gap-3 pt-4">
              <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Batal</button>
              <button type="submit" id="changePwSaveBtn" class="flex-1 btn-primary text-white px-4 py-2 rounded-lg">Simpan</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);

      const newPwInput = document.getElementById('newAccountPassword');
      const genBtn = document.getElementById('generateNewPw');
      const toggleBtn = document.getElementById('toggleNewPwVis');

      genBtn.addEventListener('click', () => { newPwInput.value = generateId().substr(0,8); newPwInput.focus(); });
      toggleBtn.addEventListener('click', () => { if (newPwInput.type === 'password') { newPwInput.type = 'text'; toggleBtn.textContent = 'ðŸ™ˆ'; } else { newPwInput.type = 'password'; toggleBtn.textContent = 'ðŸ‘ï¸'; } });

      document.getElementById('changePwForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const pwd = newPwInput.value.trim();
        if (!pwd || pwd.length < 6) { showToast('Password minimal 6 karakter!', 'error'); return; }
        try {
          const result = await window.dataSdk.update({ ...account, password: pwd });
          if (result.isOk) {
            // refresh cache
            try { const allRes = await window.dataSdk.getAll(); if (allRes && allRes.isOk) allData = allRes.data; } catch (err) { console.warn('Failed to refresh after pw change', err); }
            showToast('Password berhasil diperbarui!');
            closeModal();
            renderAccountsManagement(document.getElementById('accountTabContent'));
          } else {
            showToast('Gagal memperbarui password!', 'error');
          }
        } catch (err) { console.error('changeAccountPassword failed', err); showToast('Gagal memperbarui password!', 'error'); }
      });
    }



    function renderReportsManagement(container) {
      container.innerHTML = `
        <div class="animate-fade">
          <h1 class="text-2xl font-bold text-gray-800 mb-6">Laporan</h1>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white rounded-xl p-6 card-shadow">
              <h3 class="font-semibold text-gray-800 mb-4">Laporan Kehadiran</h3>
              <div class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-700 mb-1" for="reportClass">Kelas</label><select id="reportClass" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500"><option value="">Semua Kelas</option>${CLASSES.map(c => `<option value="${c}">Kelas ${c}</option>`).join('')}</select></div>
                <div class="flex gap-2">
                  <button onclick="exportAttendanceReport()" class="flex-1 btn-primary text-white px-4 py-3 rounded-lg">Download Laporan Kehadiran</button>
                  <button onclick="showManageAttendanceModal()" class="flex-1 px-4 py-3 border rounded-lg">Kelola</button>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl p-6 card-shadow">
              <h3 class="font-semibold text-gray-800 mb-4">Laporan Nilai</h3>
              <div class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-700 mb-1" for="gradeClass">Kelas</label><select id="gradeClass" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500"><option value="">Semua Kelas</option>${CLASSES.map(c => `<option value="${c}">Kelas ${c}</option>`).join('')}</select></div>
                <div class="flex gap-2">
                  <button onclick="exportGradeReport()" class="flex-1 btn-primary text-white px-4 py-3 rounded-lg">Download Laporan Nilai</button>
                  <button onclick="showManageGradesModal()" class="flex-1 px-4 py-3 border rounded-lg">Kelola</button>
                </div>
              </div>
            </div>
            <div class="bg-white rounded-xl p-6 card-shadow">
              <h3 class="font-semibold text-gray-800 mb-4">Laporan Kehadiran Guru</h3>
              <div class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-700 mb-1" for="teacherPeriod">Periode</label>
                  <div class="flex gap-2">
                    <select id="teacherPeriod" class="w-1/2 px-3 py-2 border rounded-lg">
                      <option value="day">Per Hari</option>
                      <option value="month">Per Bulan</option>
                      <option value="year">Per Tahun</option>
                    </select>
                    <input id="teacherPeriodValue" type="date" class="w-1/2 px-3 py-2 border rounded-lg" />
                  </div>
                </div>
                <div class="flex gap-2">
                  <button onclick="exportTeacherAttendanceReport()" class="flex-1 btn-primary text-white px-4 py-3 rounded-lg">Download Laporan Kehadiran Guru</button>
                  <button onclick="showManageTeacherAttendanceModal()" class="flex-1 px-4 py-3 border rounded-lg">Kelola</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function exportAttendanceReport() {
      const classFilter = document.getElementById('reportClass')?.value || '';
      const attendance = getAttendance();
      const filtered = classFilter ? attendance.filter(a => a.class_name === classFilter) : attendance;
      exportToExcel(filtered.map(a => {
        const student = getStudents().find(s => s.__backendId === a.student_id);
        return { Tanggal: formatDate(a.date), 'Nama Lengkap': student?.name || '-', NIS: student?.nis || '-', Kelas: a.class_name, Mapel: a.subject, Status: a.status.toUpperCase() };
      }), `Laporan_Kehadiran${classFilter ? '_Kelas_' + classFilter : ''}`);
    }

    function exportGradeReport() {
      const classFilter = document.getElementById('gradeClass')?.value || '';
      const grades = getGrades();
      const filtered = classFilter ? grades.filter(g => g.class_name === classFilter) : grades;
      exportToExcel(filtered.map(g => {
        const student = getStudents().find(s => s.__backendId === g.student_id);
        return { 'Nama Lengkap': student?.name || '-', NIS: student?.nis || '-', Kelas: g.class_name, 'Mata Pelajaran': g.subject, T1: g.task1 || '-', T2: g.task2 || '-', T3: g.task3 || '-', T4: g.task4 || '-', T5: g.task5 || '-', UH: g.daily_test || '-', Ujian: g.exam || '-' };
      }), `Laporan_Nilai${classFilter ? '_Kelas_' + classFilter : ''}`);
    }

    function exportTeacherAttendanceReport() {
      const period = document.getElementById('teacherPeriod')?.value || 'day';
      const val = document.getElementById('teacherPeriodValue')?.value || '';
      const records = getTeacherAttendance();
      let filtered = records;
      if (val) {
        if (period === 'day') {
          filtered = records.filter(r => r.date === val);
        } else if (period === 'month') {
          // val is YYYY-MM
          filtered = records.filter(r => (r.date || '').startsWith(val));
        } else if (period === 'year') {
          filtered = records.filter(r => (r.date || '').startsWith(val));
        }
      }
      const rows = filtered.map(r => {
        const teacher = getTeachers().find(t => t.__backendId === r.teacher_id);
        return { Tanggal: r.date, Nama: teacher?.name || '-', 'Kode Guru': teacher?.kode_guru || '-', Status: r.status };
      });
      const filename = `Laporan_Kehadiran_Guru_${period}_${(val||'all')}`;
      exportToExcel(rows, filename);
    }

    function showManageAttendanceModal() {
      const classFilter = document.getElementById('reportClass')?.value || '';
      const attendance = getAttendance();
      const filtered = classFilter ? attendance.filter(a => a.class_name === classFilter) : attendance;
      const modal = document.createElement('div'); modal.id = 'modal'; modal.className = 'fixed inset-0 modal-overlay flex items-start justify-center z-50 overflow-auto';
      modal.innerHTML = `
        <div class="bg-white rounded-xl card-shadow w-full max-w-4xl mx-4 my-8 animate-fade">
          <div class="p-6 border-b flex items-center justify-between"><h3 class="text-lg font-semibold">Kelola Kehadiran</h3><div class="flex items-center gap-2"><button id="att-delete-selected-btn" onclick="confirmDeleteSelectedAttendance()" class="px-3 py-1 text-white bg-red-600 rounded disabled:opacity-50" disabled>Hapus Terpilih (0)</button><button onclick="closeModal()" class="text-gray-500">Tutup</button></div></div>
          <div class="p-6">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-50"><tr><th class="px-4 py-2 text-left"><input type="checkbox" id="att-select-all" onchange="(function(){ const ch=document.getElementById('att-select-all'); document.querySelectorAll('.att-select:enabled').forEach(c=>c.checked=ch.checked); updateBulkDeleteCount('att'); })()" /></th><th class="px-4 py-2 text-left">Tanggal</th><th class="px-4 py-2 text-left">Nama</th><th class="px-4 py-2 text-left">Kelas</th><th class="px-4 py-2 text-left">Mapel</th><th class="px-4 py-2 text-left">Status</th><th class="px-4 py-2 text-left">Aksi</th></tr></thead>
                <tbody class="divide-y">${filtered.length === 0 ? `<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Tidak ada data</td></tr>` : filtered.map(a => { const student = getStudents().find(s=>s.__backendId===a.student_id); const teacher = getTeachers().find(t => t.__backendId === a.teacher_id); const canDelete = canDeleteEntry(a); return `<tr><td class="px-4 py-2"><input type="checkbox" class="att-select" data-id="${a.__backendId}" ${canDelete ? '' : 'disabled'} onchange="updateBulkDeleteCount('att')"></td><td class="px-4 py-2">${a.date || a.created_at}</td><td class="px-4 py-2">${student?.name || '-'}</td><td class="px-4 py-2">${a.class_name || '-'}</td><td class="px-4 py-2">${a.subject || '-'}</td><td class="px-4 py-2">${a.status}</td><td class="px-4 py-2">${canDelete ? `<button onclick="confirmDeleteAttendance('${a.__backendId}')" class="px-3 py-1 text-red-600 border rounded">Hapus</button>` : (teacher ? `<span class="text-xs text-gray-500">${teacher.name}</span>` : '-')}</td></tr>`; }).join('')}</tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      setTimeout(()=>updateBulkDeleteCount('att'), 50);
    }

    function confirmDeleteAttendance(id) {
      const a = allData.find(d => d.__backendId === id);
      if (!a) return;
      showConfirmModal('Hapus Absensi', `Yakin ingin menghapus absensi pada ${a.date || a.created_at}?`, async () => {
        const res = await window.dataSdk.delete(a);
        if (res.isOk) { showToast('Absensi berhasil dihapus!'); addAudit('delete','attendance', id, a); }
        else showToast('Gagal menghapus absensi!', 'error');
        closeModal(); showManageAttendanceModal();
      });
    }

    function confirmDeleteSelectedAttendance() {
      const checked = Array.from(document.querySelectorAll('.att-select:checked')).map(c => c.dataset.id);
      if (checked.length === 0) { showToast('Tidak ada entri yang dipilih', 'error'); return; }
      showConfirmModal('Hapus Absensi Terpilih', `Yakin ingin menghapus ${checked.length} entri absensi terpilih?`, async () => {
        let deleted = 0;
        for (const id of checked) {
          const a = allData.find(d => d.__backendId === id);
          if (!a) continue;
          const res = await window.dataSdk.delete(a);
          if (res.isOk) { deleted++; addAudit('delete','attendance', id, a); }
        }
        showToast(`Berhasil menghapus ${deleted} entri`);
        closeModal(); showManageAttendanceModal();
      });
    }

    function showManageGradesModal() {
      const classFilter = document.getElementById('gradeClass')?.value || '';
      const grades = getGrades();
      const filtered = classFilter ? grades.filter(g => g.class_name === classFilter) : grades;
      const modal = document.createElement('div'); modal.id = 'modal'; modal.className = 'fixed inset-0 modal-overlay flex items-start justify-center z-50 overflow-auto';
      modal.innerHTML = `
        <div class="bg-white rounded-xl card-shadow w-full max-w-4xl mx-4 my-8 animate-fade">
          <div class="p-6 border-b flex items-center justify-between"><h3 class="text-lg font-semibold">Kelola Nilai</h3><div class="flex items-center gap-2"><button id="grade-delete-selected-btn" onclick="confirmDeleteSelectedGrade()" class="px-3 py-1 text-white bg-red-600 rounded disabled:opacity-50" disabled>Hapus Terpilih (0)</button><button onclick="closeModal()" class="text-gray-500">Tutup</button></div></div>
          <div class="p-6">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-50"><tr><th class="px-4 py-2 text-left"><input type="checkbox" id="grade-select-all" onchange="(function(){ const ch=document.getElementById('grade-select-all'); document.querySelectorAll('.grade-select:enabled').forEach(c=>{ const row = c.closest('tr'); if (row && row.offsetParent !== null) c.checked = ch.checked; else c.checked = false; }); updateBulkDeleteCount('grade'); })()" /></th><th class="px-4 py-2 text-left">Tanggal</th><th class="px-4 py-2 text-left">Nama</th><th class="px-4 py-2 text-left">Kelas</th><th class="px-4 py-2 text-left">Mapel</th><th class="px-4 py-2 text-left">Aksi</th></tr></thead>
                <tbody class="divide-y">${filtered.length === 0 ? `<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">Tidak ada data</td></tr>` : filtered.map(g => { const student = getStudents().find(s=>s.__backendId===g.student_id); const teacher = getTeachers().find(t => t.__backendId === g.teacher_id); const canDelete = canDeleteEntry(g); return `<tr><td class="px-4 py-2"><input type="checkbox" class="grade-select" data-id="${g.__backendId}" ${canDelete ? '' : 'disabled'} onchange="updateBulkDeleteCount('grade')"></td><td class="px-4 py-2">${g.date || g.created_at}</td><td class="px-4 py-2">${student?.name || '-'}</td><td class="px-4 py-2">${g.class_name || '-'}</td><td class="px-4 py-2">${g.subject || '-'}</td><td class="px-4 py-2">${canDelete ? `<button onclick="confirmDeleteGrade('${g.__backendId}')" class="px-3 py-1 text-red-600 border rounded">Hapus</button>` : (teacher ? `<span class="text-xs text-gray-500">${teacher.name}</span>` : '-')}</td></tr>`; }).join('')}</tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      setTimeout(()=>updateBulkDeleteCount('grade'), 50);
    }

    function showManageTeacherAttendanceModal() {
      const val = document.getElementById('teacherPeriodValue')?.value || '';
      const period = document.getElementById('teacherPeriod')?.value || 'day';
      const records = getTeacherAttendance();
      let filtered = records;
      if (val) {
        if (period === 'day') filtered = records.filter(r => r.date === val);
        else if (period === 'month') filtered = records.filter(r => (r.date||'').startsWith(val));
        else if (period === 'year') filtered = records.filter(r => (r.date||'').startsWith(val));
      }
      const modal = document.createElement('div'); modal.id = 'modal'; modal.className = 'fixed inset-0 modal-overlay flex items-start justify-center z-50 overflow-auto';
      modal.innerHTML = `
        <div class="bg-white rounded-xl card-shadow w-full max-w-4xl mx-4 my-8 animate-fade">
          <div class="p-6 border-b flex items-center justify-between"><h3 class="text-lg font-semibold">Kelola Kehadiran Guru</h3><div class="flex items-center gap-2"><button id="teacher-delete-selected-btn" onclick="confirmDeleteSelectedTeacherAttendance()" class="px-3 py-1 text-white bg-red-600 rounded disabled:opacity-50" disabled>Hapus Terpilih (0)</button><button onclick="closeModal()" class="text-gray-500">Tutup</button></div></div>
          <div class="p-6">
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-50"><tr><th class="px-4 py-2 text-left"><input type="checkbox" id="teacher-select-all" onchange="(function(){ const ch=document.getElementById('teacher-select-all'); document.querySelectorAll('.teacher-select:enabled').forEach(c=>c.checked=ch.checked); updateBulkDeleteCount('teacher'); })()" /></th><th class="px-4 py-2 text-left">Tanggal</th><th class="px-4 py-2 text-left">Nama Guru</th><th class="px-4 py-2 text-left">Kode Guru</th><th class="px-4 py-2 text-left">Status</th><th class="px-4 py-2 text-left">Aksi</th></tr></thead>
                <tbody class="divide-y">${filtered.length === 0 ? `<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">Tidak ada data</td></tr>` : filtered.map(r => { const teacher = getTeachers().find(t=>t.__backendId===r.teacher_id); const canDelete = canDeleteEntry(r); return `<tr><td class="px-4 py-2"><input type="checkbox" class="teacher-select" data-id="${r.__backendId}" ${canDelete ? '' : 'disabled'} onchange="updateBulkDeleteCount('teacher')"></td><td class="px-4 py-2">${r.date || r.created_at}</td><td class="px-4 py-2">${teacher?.name || '-'}</td><td class="px-4 py-2">${teacher?.kode_guru || '-'}</td><td class="px-4 py-2">${r.status}</td><td class="px-4 py-2">${canDelete ? `<button onclick="confirmDeleteTeacherAttendance('${r.__backendId}')" class="px-3 py-1 text-red-600 border rounded">Hapus</button>` : (teacher ? `<span class="text-xs text-gray-500">${teacher.name}</span>` : '-')}</td></tr>`; }).join('')}</tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      setTimeout(()=>updateBulkDeleteCount('teacher'), 50);
    }

    function confirmDeleteGrade(id) {
      const g = allData.find(d => d.__backendId === id);
      if (!g) return;
      showConfirmModal('Hapus Nilai', `Yakin ingin menghapus nilai ${g.subject || ''} pada ${g.date || g.created_at}?`, async () => {
        const res = await window.dataSdk.delete(g);
        if (res.isOk) { showToast('Nilai berhasil dihapus!'); addAudit('delete','grade', id, g); }
        else showToast('Gagal menghapus nilai!', 'error');
        closeModal(); showManageGradesModal();
      });
    }

    function confirmDeleteSelectedGrade() {
      const checkedEls = Array.from(document.querySelectorAll('.grade-select:checked'));
      const checked = checkedEls.map(c => c.dataset.id);
      if (checked.length === 0) { showToast('Tidak ada entri yang dipilih', 'error'); return; }
      const classFilter = document.getElementById('gradeClass')?.value || '';
      const warning = !classFilter ? `PERINGATAN: Anda memilih <strong>Semua Kelas</strong>. Ini akan menghapus ${checked.length} entri di seluruh kelas.` : `Yakin ingin menghapus ${checked.length} entri nilai terpilih?`;
      // If all classes are selected, make the warning explicit
      showConfirmModal('Hapus Nilai Terpilih', warning, async () => {
        let deleted = 0;
        for (const id of checked) {
          const g = allData.find(d => d.__backendId === id);
          if (!g) continue;
          const res = await window.dataSdk.delete(g);
          if (res.isOk) { deleted++; addAudit('delete','grade', id, g); }
        }
        showToast(`Berhasil menghapus ${deleted} entri`);
        closeModal(); showManageGradesModal();
      });
    }

    function confirmDeleteSelectedTeacherAttendance() {
      const checked = Array.from(document.querySelectorAll('.teacher-select:checked')).map(c => c.dataset.id);
      if (checked.length === 0) { showToast('Tidak ada entri yang dipilih', 'error'); return; }
      showConfirmModal('Hapus Kehadiran Guru Terpilih', `Yakin ingin menghapus ${checked.length} entri kehadiran guru terpilih?`, async () => {
        let deleted = 0;
        for (const id of checked) {
          const t = allData.find(d => d.__backendId === id);
          if (!t) continue;
          const res = await window.dataSdk.delete(t);
          if (res.isOk) { deleted++; addAudit('delete','teacher_attendance', id, t); }
        }
        showToast(`Berhasil menghapus ${deleted} entri`);
        closeModal(); showManageTeacherAttendanceModal();
      });
    }

    function confirmDeleteTeacherAttendance(id) {
      const t = allData.find(d => d.__backendId === id);
      if (!t) return;
      showConfirmModal('Hapus Kehadiran Guru', `Yakin ingin menghapus kehadiran guru pada ${t.date || t.created_at}?`, async () => {
        const res = await window.dataSdk.delete(t);
        if (res.isOk) { showToast('Kehadiran guru berhasil dihapus!'); addAudit('delete','teacher_attendance', id, t); }
        else showToast('Gagal menghapus kehadiran guru!', 'error');
        closeModal(); showManageTeacherAttendanceModal();
      });
    }

    function updateBulkDeleteCount(type) {
      if (type === 'att') {
        const cnt = document.querySelectorAll('.att-select:checked').length;
        const btn = document.getElementById('att-delete-selected-btn'); if (btn) { btn.textContent = `Hapus Terpilih (${cnt})`; btn.disabled = cnt === 0; }
      } else if (type === 'grade') {
        const cnt = document.querySelectorAll('.grade-select:checked').length;
        const btn = document.getElementById('grade-delete-selected-btn'); if (btn) { btn.textContent = `Hapus Terpilih (${cnt})`; btn.disabled = cnt === 0; }
      } else if (type === 'teacher') {
        const cnt = document.querySelectorAll('.teacher-select:checked').length;
        const btn = document.getElementById('teacher-delete-selected-btn'); if (btn) { btn.textContent = `Hapus Terpilih (${cnt})`; btn.disabled = cnt === 0; }
      }
    }
  

    // ==================== TEACHER DASHBOARD ====================
    function renderTeacherDashboard() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="h-full flex flex-col">
          <header class="gradient-bg text-white p-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <img src="logosmppas4.jpg" alt="Logo" class="w-10 h-10 rounded-full object-cover">
                <div>
                  <h1 class="text-xl font-bold">${config.school_name || defaultConfig.school_name}</h1>
                  <p class="text-sm text-white/70">Selamat datang, ${currentUser.name}</p>
                </div>
              </div>
              <button onclick="logout()" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                Keluar
              </button>
            </div>
          </header>
          <div class="flex-1 overflow-auto p-6 bg-gray-100">
            <div id="teacherContent"></div>
          </div>
        </div>
      `;
      renderTeacherClassSelection();
    }

    let selectedClass = null;
    let selectedSubject = null;

    function renderTeacherClassSelection() {
      const teacher = getTeachers().find(t => t.__backendId === currentUser.id);
      const teacherClasses = teacher?.class_name?.split(',').filter(c => c) || [];
      const teacherSubjects = teacher?.subject?.split(',').filter(s => s) || [];
      const content = document.getElementById('teacherContent');
      content.innerHTML = `
        <div class="animate-fade">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">Pilih Kelas dan Mata Pelajaran</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-xl p-6 card-shadow">
              <h3 class="font-semibold text-gray-800 mb-4">Pilih Mata Pelajaran</h3>
              <select id="subjectSelect" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">
                <option value="">-- Pilih Mapel --</option>
                ${teacherSubjects.map(s => `<option value="${s}">${s}</option>`).join('')}
              </select>
            </div>
            <div class="bg-white rounded-xl p-6 card-shadow">
              <h3 class="font-semibold text-gray-800 mb-4">Pilih Kelas</h3>
              <select id="classSelect" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">
                <option value="">-- Pilih Kelas --</option>
                ${teacherClasses.map(c => `<option value="${c}">Kelas ${c}</option>`).join('')}
              </select>
            </div>
          </div>
          <div class="flex gap-4">
            <button onclick="startAttendance()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-6 py-4 rounded-xl font-semibold flex items-center justify-center gap-3">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
              Mulai Absensi
            </button>
            <button onclick="startGrading()" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-6 py-4 rounded-xl font-semibold flex items-center justify-center gap-3">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
              Input Nilai
            </button>
          </div>
          <div class="mt-6">
            <div class="bg-white rounded-xl p-6 card-shadow">
              <h3 class="font-semibold text-gray-800 mb-4">Absensi Guru (Diri Sendiri)</h3>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                <div>
                  <label class="text-xs text-gray-500">Tanggal</label>
                  <input id="teacher-att-date" type="date" value="${new Date().toISOString().split('T')[0]}" class="mt-1 w-full border rounded px-2 py-1 text-sm" />
                </div>
                <div>
                  <label class="text-xs text-gray-500">Status</label>
                  <select id="teacher-att-status" class="mt-1 w-full border rounded px-2 py-1 text-sm">
                    <option value="hadir">Hadir</option>
                    <option value="sakit">Sakit</option>
                    <option value="izin">Izin</option>
                    <option value="alpha">Alpha</option>
                  </select>
                </div>
                <div class="flex items-end">
                  <button onclick="saveTeacherAttendance()" class="w-full btn-primary text-white px-4 py-2 rounded-lg">Simpan Absensi Guru</button>
                </div>
              </div>
              <div id="teacher-att-current" class="text-sm text-gray-600"></div>
            </div>
          </div>
        </div>
      `;
      renderTeacherSelfAttendance();
    }

    function startAttendance() {
      const classSelect = document.getElementById('classSelect');
      const subjectSelect = document.getElementById('subjectSelect');
      if (!subjectSelect?.value) { showToast('Pilih mata pelajaran terlebih dahulu!', 'error'); return; }
      if (!classSelect?.value) { showToast('Pilih kelas terlebih dahulu!', 'error'); return; }
      selectedClass = classSelect.value;
      selectedSubject = subjectSelect.value;
      attendanceData = {};
      renderAttendanceForm();
    }

    function renderTeacherSelfAttendance() {
      const dateInput = document.getElementById('teacher-att-date');
      const statusInput = document.getElementById('teacher-att-status');
      const info = document.getElementById('teacher-att-current');
      const date = dateInput?.value || new Date().toISOString().split('T')[0];
      const existing = getTeacherAttendance().find(a => a.teacher_id === currentUser.id && (a.date === date || (a.date && a.date.startsWith(date))));
      if (existing) {
        info.innerHTML = `Status terdaftar: <strong class="text-green-600">${existing.status}</strong> (tercatat: ${existing.created_at || existing.date}) <button onclick="showEditTeacherAttendanceModal('${existing.__backendId}')" class="ml-3 px-2 py-1 border rounded text-sm">Edit</button>`;
      } else {
        info.innerHTML = `Belum ada absensi untuk tanggal <strong>${date}</strong>`;
      }
      // attach onchange to update info
      if (dateInput) dateInput.addEventListener('change', () => renderTeacherSelfAttendance());
    }

    async function saveTeacherAttendance() {
      const date = document.getElementById('teacher-att-date')?.value;
      const status = document.getElementById('teacher-att-status')?.value;
      if (!date) { showToast('Pilih tanggal!', 'error'); return; }
      const existing = getTeacherAttendance().find(a => a.teacher_id === currentUser.id && a.date === date);
      if (existing) {
        const res = await window.dataSdk.update({ ...existing, status, date });
        if (res.isOk) { showToast('Absensi guru diperbarui!'); addAudit('update','teacher_attendance', existing.__backendId, { date, status }); }
        else showToast('Gagal memperbarui absensi guru', 'error');
      } else {
        const res = await window.dataSdk.create({ type: 'teacher_attendance', teacher_id: currentUser.id, date, status, created_at: new Date().toISOString() });
        if (res.isOk) { showToast('Absensi guru tersimpan!'); addAudit('create','teacher_attendance', null, { date, status, teacher_id: currentUser.id }); }
        else showToast('Gagal menyimpan absensi guru', 'error');
      }
      renderTeacherSelfAttendance();
    }

    function showEditTeacherAttendanceModal(id) {
      const item = allData.find(d => d.__backendId === id);
      if (!item) return;
      const modal = document.createElement('div'); modal.id = 'modal'; modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-xl card-shadow w-full max-w-md mx-4 animate-fade">
          <div class="p-6 border-b"><h3 class="text-lg font-semibold">Edit Absensi Guru</h3></div>
          <form id="editTeacherAttForm" class="p-6 space-y-4">
            <div><label class="block text-sm text-gray-700">Tanggal</label><input type="date" id="editTeacherAttDate" value="${item.date}" class="w-full px-3 py-2 border rounded-lg" required></div>
            <div><label class="block text-sm text-gray-700">Status</label><select id="editTeacherAttStatus" class="w-full px-3 py-2 border rounded-lg"><option value="hadir" ${item.status==='hadir'?'selected':''}>Hadir</option><option value="sakit" ${item.status==='sakit'?'selected':''}>Sakit</option><option value="izin" ${item.status==='izin'?'selected':''}>Izin</option><option value="alpha" ${item.status==='alpha'?'selected':''}>Alpha</option></select></div>
            <div class="flex gap-3 pt-4"><button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg">Batal</button><button type="submit" class="flex-1 btn-primary text-white px-4 py-2 rounded-lg">Simpan</button></div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById('editTeacherAttForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const date = document.getElementById('editTeacherAttDate').value;
        const status = document.getElementById('editTeacherAttStatus').value;
        const res = await window.dataSdk.update({ ...item, date, status });
        if (res.isOk) { showToast('Absensi guru diperbarui!'); addAudit('update','teacher_attendance', item.__backendId, { date, status }); }
        else showToast('Gagal memperbarui absensi guru', 'error');
        closeModal(); renderTeacherSelfAttendance();
      });
    }

    function renderAttendanceForm() {
      const students = getStudents().filter(s => s.class_name === selectedClass).sort((a, b) => a.name.localeCompare(b.name));
      const today = new Date().toISOString().split('T')[0];
      totalStudentsForAttendance = students.length;
      
      const content = document.getElementById('teacherContent');
      content.innerHTML = `
        <div class="animate-fade">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">Absensi Kelas ${selectedClass}</h2>
              <p class="text-gray-600">${selectedSubject}</p>
            </div>
            <button onclick="renderTeacherClassSelection()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Kembali</button>
          </div>
          
          <div class="bg-white rounded-xl p-4 card-shadow mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2" for="attendanceDate">ðŸ“… Pilih Tanggal</label>
            <input type="date" id="attendanceDate" value="${today}" max="${today}" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 w-full md:w-auto">
          </div>
          
          <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-4">
            <p class="text-amber-700 text-sm font-medium" id="attendanceProgress">ðŸ“Š Progress: 0 dari ${students.length} siswa</p>
          </div>
          
          <div class="bg-white rounded-xl card-shadow overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">No</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Nama Lengkap</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">NIS</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase">Status</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase">âœ“</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase">Aksi</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                  ${students.length === 0 ? `<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Tidak ada siswa</td></tr>` : students.map((s, i) => `
                    <tr class="table-row" id="att-row-${s.__backendId}">
                      <td class="px-4 py-4 text-sm text-gray-600">${i + 1}</td>
                      <td class="px-4 py-4 text-sm font-medium text-gray-800">${s.name}</td>
                      <td class="px-4 py-4 text-sm text-gray-600">${s.nis}</td>
                      <td class="px-4 py-4">
                        <div class="flex justify-center gap-2">
                          <button onclick="setAttendance('${s.__backendId}', 'hadir', this)" class="att-btn px-3 py-1 rounded-full text-xs font-medium bg-gray-200 hover:bg-green-500 hover:text-white transition">H</button>
                          <button onclick="setAttendance('${s.__backendId}', 'sakit', this)" class="att-btn px-3 py-1 rounded-full text-xs font-medium bg-gray-200 hover:bg-blue-500 hover:text-white transition">S</button>
                          <button onclick="setAttendance('${s.__backendId}', 'izin', this)" class="att-btn px-3 py-1 rounded-full text-xs font-medium bg-gray-200 hover:bg-amber-500 hover:text-white transition">I</button>
                          <button onclick="setAttendance('${s.__backendId}', 'alpha', this)" class="att-btn px-3 py-1 rounded-full text-xs font-medium bg-gray-200 hover:bg-red-500 hover:text-white transition">A</button>
                        </div>
                      </td>
                      <td class="px-4 py-4 text-center" id="att-status-${s.__backendId}"><span class="text-xs text-gray-400">-</span></td>
                      <td class="px-4 py-4 text-center att-actions-cell" id="att-actions-${s.__backendId}"></td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            <div class="p-4 border-t bg-gray-50">
              <button id="saveAttendanceBtn" onclick="saveAttendance()" disabled class="w-full bg-gray-300 text-gray-500 px-6 py-3 rounded-lg font-semibold cursor-not-allowed">âš ï¸ Isi semua siswa</button>
            </div>
          </div>
        </div>
      `;

      // after rendering, populate possible existing attendance records and attach change listener
      const attDateEl = document.getElementById('attendanceDate');
      if (attDateEl) {
        attDateEl.addEventListener('change', populateAttendanceActions);
        attDateEl.addEventListener('input', populateAttendanceActions);
      }
      setTimeout(populateAttendanceActions, 10);
    }

    function setAttendance(studentId, status, btn) {
      attendanceData[studentId] = status;
      const row = document.getElementById(`att-row-${studentId}`);
      row.querySelectorAll('.att-btn').forEach(b => { b.classList.remove('bg-green-500', 'bg-blue-500', 'bg-amber-500', 'bg-red-500', 'text-white'); b.classList.add('bg-gray-200'); });
      const colors = { hadir: 'bg-green-500', sakit: 'bg-blue-500', izin: 'bg-amber-500', alpha: 'bg-red-500' };
      btn.classList.remove('bg-gray-200'); btn.classList.add(colors[status], 'text-white');
      document.getElementById(`att-status-${studentId}`).innerHTML = `<span class="text-green-500 font-bold">âœ“</span>`;
      row.classList.add('row-filled');
      updateAttendanceProgress();
    }

    function updateAttendanceProgress() {
      const filled = Object.keys(attendanceData).length;
      const total = totalStudentsForAttendance;
      const progressEl = document.getElementById('attendanceProgress');
      const saveBtn = document.getElementById('saveAttendanceBtn');
      if (progressEl) progressEl.textContent = `ðŸ“Š Progress: ${filled} dari ${total} siswa`;
      if (saveBtn) {
        if (filled === total && total > 0) { saveBtn.disabled = false; saveBtn.className = 'w-full btn-primary text-white px-6 py-3 rounded-lg font-semibold transition'; saveBtn.textContent = 'ðŸ’¾ Simpan Absensi'; }
        else { saveBtn.disabled = true; saveBtn.className = 'w-full bg-gray-300 text-gray-500 px-6 py-3 rounded-lg font-semibold cursor-not-allowed'; saveBtn.textContent = `âš ï¸ Isi semua siswa (${total - filled} lagi)`; }
      }
    }

    async function saveAttendance() {
      const selectedDate = document.getElementById('attendanceDate')?.value;
      if (!selectedDate) { showToast('Pilih tanggal!', 'error'); return; }
      const students = getStudents().filter(s => s.class_name === selectedClass);
      const filledCount = Object.keys(attendanceData).length;
      if (filledCount !== students.length) { showToast(`Isi semua siswa! (${students.length - filledCount} lagi)`, 'error'); return; }
      const saveBtn = document.getElementById('saveAttendanceBtn');
      saveBtn.disabled = true; saveBtn.textContent = 'â³ Menyimpan...';
      let saved = 0;
      for (const student of students) {
        const status = attendanceData[student.__backendId];
        if (!status) continue;
        if (allData.length >= 999) { showToast('Batas data tercapai!', 'error'); break; }
        const existing = getAttendance().find(a => a.student_id === student.__backendId && a.date === selectedDate && a.subject === selectedSubject);
        if (existing) await window.dataSdk.update({ ...existing, status });
        else await window.dataSdk.create({ type: 'attendance', student_id: student.__backendId, class_name: selectedClass, subject: selectedSubject, date: selectedDate, status, teacher_id: currentUser.id, created_at: new Date().toISOString() });
        saved++;
      }
      showToast(`Absensi ${saved} siswa disimpan!`);
      attendanceData = {};
      renderTeacherClassSelection();
    }

    function startGrading() {
      const classSelect = document.getElementById('classSelect');
      const subjectSelect = document.getElementById('subjectSelect');
      if (!subjectSelect?.value) { showToast('Pilih mata pelajaran!', 'error'); return; }
      if (!classSelect?.value) { showToast('Pilih kelas!', 'error'); return; }
      selectedClass = classSelect.value;
      selectedSubject = subjectSelect.value;
      gradeData = {};
      renderGradingForm();
    }

    function renderGradingForm() {
      const students = getStudents().filter(s => s.class_name === selectedClass).sort((a, b) => a.name.localeCompare(b.name));
      const today = new Date().toISOString().split('T')[0];
      totalStudentsForGrade = students.length;
      
      const content = document.getElementById('teacherContent');
      content.innerHTML = `
        <div class="animate-fade">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">Input Nilai Kelas ${selectedClass}</h2>
              <p class="text-gray-600">${selectedSubject}</p>
            </div>
            <button onclick="renderTeacherClassSelection()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Kembali</button>
          </div>
          
          <div class="bg-white rounded-xl p-4 card-shadow mb-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2" for="assessmentType">ðŸ“ Jenis Penilaian</label>
                <select id="assessmentType" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">${ASSESSMENT_TYPES.map(t => `<option value="${t.value}">${t.label}</option>`).join('')}</select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2" for="gradeDate">ðŸ“… Tanggal</label>
                <input type="date" id="gradeDate" value="${today}" max="${today}" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">
              </div>
            </div>
          </div>
          
          <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-4">
            <p class="text-amber-700 text-sm font-medium" id="gradeProgress">ðŸ“Š Progress: 0 dari ${students.length} siswa</p>
          </div>
          
          <div class="bg-white rounded-xl card-shadow overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">No</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Nama Lengkap</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">NIS</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase">Nilai</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase">âœ“</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                  ${students.length === 0 ? `<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Tidak ada siswa</td></tr>` : students.map((s, i) => `
                    <tr class="table-row" id="grade-row-${s.__backendId}">
                      <td class="px-4 py-4 text-sm text-gray-600">${i + 1}</td>
                      <td class="px-4 py-4 text-sm font-medium text-gray-800">${s.name}</td>
                      <td class="px-4 py-4 text-sm text-gray-600">${s.nis}</td>
                      <td class="px-4 py-4 text-center"><input id="grade-input-${s.__backendId}" type="number" min="0" max="100" class="w-20 px-3 py-2 border rounded-lg text-center focus:ring-2 focus:ring-amber-500" oninput="setGrade('${s.__backendId}', this.value)" placeholder="-"></td>
                      <td class="px-4 py-4 text-center" id="grade-status-${s.__backendId}"><span class="text-xs text-gray-400">-</span></td>
                      <td class="px-4 py-4 text-center grade-actions-cell" id="grade-actions-${s.__backendId}"></td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            <div class="p-4 border-t bg-gray-50">
              <button id="saveGradeBtn" onclick="saveGrades()" disabled class="w-full bg-gray-300 text-gray-500 px-6 py-3 rounded-lg font-semibold cursor-not-allowed">âš ï¸ Isi semua siswa</button>
            </div>
          </div>
        </div>
      `;

      // after rendering, populate grade actions and attach listeners
      const gradeDateEl = document.getElementById('gradeDate');
      const assessmentEl = document.getElementById('assessmentType');
      if (gradeDateEl) { gradeDateEl.addEventListener('change', populateGradeActions); gradeDateEl.addEventListener('input', populateGradeActions); }
      if (assessmentEl) { assessmentEl.addEventListener('change', populateGradeActions); }
      setTimeout(populateGradeActions, 10);
    }

    function setGrade(studentId, value) {
      const row = document.getElementById(`grade-row-${studentId}`);
      const statusEl = document.getElementById(`grade-status-${studentId}`);
      if (value !== '' && !isNaN(value) && parseInt(value) >= 0 && parseInt(value) <= 100) {
        gradeData[studentId] = parseInt(value);
        statusEl.innerHTML = `<span class="text-green-500 font-bold">âœ“</span>`;
        row.classList.add('row-filled');
      } else {
        delete gradeData[studentId];
        statusEl.innerHTML = `<span class="text-xs text-gray-400">-</span>`;
        row.classList.remove('row-filled');
      }
      updateGradeProgress();
    }

    function updateGradeProgress() {
      const filled = Object.keys(gradeData).length;
      const total = totalStudentsForGrade;
      const progressEl = document.getElementById('gradeProgress');
      const saveBtn = document.getElementById('saveGradeBtn');
      if (progressEl) progressEl.textContent = `ðŸ“Š Progress: ${filled} dari ${total} siswa`;
      if (saveBtn) {
        if (filled === total && total > 0) { saveBtn.disabled = false; saveBtn.className = 'w-full btn-primary text-white px-6 py-3 rounded-lg font-semibold transition'; saveBtn.textContent = 'ðŸ’¾ Simpan Nilai'; }
        else { saveBtn.disabled = true; saveBtn.className = 'w-full bg-gray-300 text-gray-500 px-6 py-3 rounded-lg font-semibold cursor-not-allowed'; saveBtn.textContent = `âš ï¸ Isi semua siswa (${total - filled} lagi)`; }
      }
    }

    async function saveGrades() {
      const assessmentType = document.getElementById('assessmentType')?.value;
      const selectedDate = document.getElementById('gradeDate')?.value;
      if (!assessmentType) { showToast('Pilih jenis penilaian!', 'error'); return; }
      if (!selectedDate) { showToast('Pilih tanggal!', 'error'); return; }
      const students = getStudents().filter(s => s.class_name === selectedClass);
      const filledCount = Object.keys(gradeData).length;
      if (filledCount !== students.length) { showToast(`Isi semua siswa! (${students.length - filledCount} lagi)`, 'error'); return; }
      const saveBtn = document.getElementById('saveGradeBtn');
      saveBtn.disabled = true; saveBtn.textContent = 'â³ Menyimpan...';
      const assessmentLabel = ASSESSMENT_TYPES.find(t => t.value === assessmentType)?.label || assessmentType;
      let saved = 0;
      for (const student of students) {
        const value = gradeData[student.__backendId];
        if (value === undefined) continue;
        if (allData.length >= 999) { showToast('Batas data tercapai!', 'error'); break; }
        const existing = getGrades().find(g => g.student_id === student.__backendId && g.subject === selectedSubject);
        if (existing) await window.dataSdk.update({ ...existing, [assessmentType]: value, date: selectedDate });
        else await window.dataSdk.create({ type: 'grade', student_id: student.__backendId, class_name: selectedClass, subject: selectedSubject, teacher_id: currentUser.id, [assessmentType]: value, date: selectedDate, created_at: new Date().toISOString() });
        saved++;
      }
      showToast(`Nilai ${assessmentLabel} ${saved} siswa disimpan!`);
      gradeData = {};
      renderTeacherClassSelection();
    }

    // ==================== HOMEROOM & STUDENT DASHBOARD ====================
    function renderHomeroomDashboard() {
      const homeroom = getHomerooms().find(h => h.__backendId === currentUser.id);
      const className = homeroom?.class_name || currentUser.class_name;
      const app = document.getElementById('app');

      const period = homeroomDashboardPeriod || 'week';
      const selectedDate = new Date(homeroomDashboardDate || new Date().toISOString().split('T')[0]);

      function getRange(period, dateObj) {
        const d = new Date(dateObj);
        d.setHours(0,0,0,0);
        if (period === 'day') {
          return { start: new Date(d), end: new Date(d) };
        } else if (period === 'week') {
          const day = d.getDay();
          const diffToMonday = (day + 6) % 7;
          const start = new Date(d);
          start.setDate(d.getDate() - diffToMonday);
          start.setHours(0,0,0,0);
          const end = new Date(start);
          end.setDate(start.getDate() + 6);
          end.setHours(23,59,59,999);
          return { start, end };
        } else {
          const start = new Date(d.getFullYear(), d.getMonth(), 1);
          const end = new Date(d.getFullYear(), d.getMonth() + 1, 0, 23,59,59,999);
          return { start, end };
        }
      }

      function inRange(itemDateStr, start, end) {
        if (!itemDateStr) return false;
        const d = new Date(itemDateStr);
        return d >= start && d <= end;
      }

      const range = getRange(period, selectedDate);
      const attendanceInRange = getAttendance().filter(a => a.class_name === className && inRange(a.date || a.created_at, range.start, range.end));
      const gradesInRange = getGrades().filter(g => g.class_name === className && inRange(g.date || g.created_at, range.start, range.end));

      const subjectsSet = new Set();
      attendanceInRange.forEach(a => { if (a.subject) subjectsSet.add(a.subject); });
      gradesInRange.forEach(g => { if (g.subject) subjectsSet.add(g.subject); });
      SUBJECTS.forEach(s => subjectsSet.add(s));
      const subjects = Array.from(subjectsSet).sort();

      const attendanceSummary = subjects.map(sub => {
        const list = attendanceInRange.filter(a => (a.subject || '').toLowerCase() === sub.toLowerCase());
        const total = list.length;
        const hadir = list.filter(x => x.status === 'hadir').length;
        const izin = list.filter(x => x.status === 'izin').length;
        const sakit = list.filter(x => x.status === 'sakit').length;
        const alpha = list.filter(x => x.status === 'alpha').length;
        return { subject: sub, total, hadir, izin, sakit, alpha };
      });

      const gradesBySubject = subjects.map(sub => {
        const list = gradesInRange.filter(g => (g.subject || '').toLowerCase() === sub.toLowerCase());
        const finals = list.map(g => {
          const tasks = [g.task1, g.task2, g.task3, g.task4, g.task5].filter(t => t != null);
          const taskAvg = tasks.length > 0 ? tasks.reduce((a,b)=>a+b,0)/tasks.length : 0;
          const finalGrade = (taskAvg * 0.4) + ((g.daily_test || 0) * 0.3) + ((g.exam || 0) * 0.3);
          return { ...g, finalGrade };
        });
        const avgFinal = finals.length > 0 ? (finals.reduce((a,b)=>a+b.finalGrade,0)/finals.length) : null;
        const latest = finals.sort((a,b)=> new Date(b.date || b.created_at) - new Date(a.date || a.created_at))[0] || null;
        return { subject: sub, avgFinal, latest };
      });

      const todayStr = new Date().toISOString().split('T')[0];
      const todayAttendance = getAttendance().filter(a => a.class_name === className && a.date === todayStr);

      app.innerHTML = `
        <div class="h-full flex flex-col">
          <header class="gradient-bg text-white p-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <img src="logosmppas4.jpg" alt="Logo" class="w-10 h-10 rounded-full object-cover">
                <div>
                  <h1 class="text-xl font-bold">${config.school_name || defaultConfig.school_name}</h1>
                  <p class="text-sm text-white/70">Wali Kelas ${className} - ${currentUser.name}</p>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <button onclick="exportHomeroom('${className}')" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg flex items-center gap-2">Download Excel</button>
                <button onclick="logout()" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg flex items-center gap-2">Keluar</button>
              </div>
            </div>
          </header>
          <div class="flex-1 overflow-auto p-6 bg-gray-100">
            <div class="animate-fade space-y-4">
              <div class="bg-white rounded-xl p-4 card-shadow">
                <div class="flex items-center gap-3 flex-wrap">
                  <label class="text-sm text-gray-600">Periode:</label>
                  <select id="homeroomPeriodSelect" class="px-3 py-2 border rounded-lg" onchange="homeroomDashboardPeriod = this.value; renderHomeroomDashboard();">
                    <option value="day" ${period==='day'?'selected':''}>Hari</option>
                    <option value="week" ${period==='week'?'selected':''}>Minggu</option>
                    <option value="month" ${period==='month'?'selected':''}>Bulan</option>
                  </select>
                  <label class="text-sm text-gray-600">Tanggal acuan:</label>
                  <input id="homeroomDateInput" type="date" value="${homeroomDashboardDate}" class="px-3 py-2 border rounded-lg" onchange="homeroomDashboardDate=this.value; renderHomeroomDashboard();">
                </div>
              </div>

              <!-- Absensi per mata pelajaran & ringkasan nilai dihapus sesuai permintaan -->

            </div>
          </div>
        </div>
      `;

      // append per-student table for this homeroom and selected period
      (function() {
        const students = getStudents().filter(s => s.class_name === className).sort((a,b) => a.name.localeCompare(b.name));
        const rows = students.map((s,i) => {
          const att = attendanceInRange.filter(a => a.student_id === s.__backendId);
          const hadir = att.filter(a => a.status === 'hadir').length;
          const izin = att.filter(a => a.status === 'izin').length;
          const sakit = att.filter(a => a.status === 'sakit').length;
          const alpha = att.filter(a => a.status === 'alpha').length;
          const gradeList = gradesInRange.filter(g => g.student_id === s.__backendId);
          const finals = gradeList.map(g => { const tasks = [g.task1,g.task2,g.task3,g.task4,g.task5].filter(t => t != null); const taskAvg = tasks.length ? tasks.reduce((a,b)=>a+b,0)/tasks.length : 0; return (taskAvg * 0.4) + ((g.daily_test || 0) * 0.3) + ((g.exam || 0) * 0.3); });
          const avgFinal = finals.length > 0 ? (finals.reduce((a,b)=>a+b,0)/finals.length) : null;
          return `<tr><td class="px-4 py-2">${i+1}</td><td class="px-4 py-2 font-medium">${s.name}</td><td class="px-4 py-2">${s.nis}</td><td class="px-4 py-2">${hadir}</td><td class="px-4 py-2">${izin}</td><td class="px-4 py-2">${sakit}</td><td class="px-4 py-2">${alpha}</td><td class="px-4 py-2">${avgFinal !== null ? avgFinal.toFixed(1) : '-'}</td><td class="px-4 py-2"><div class="flex gap-2"><button onclick="showStudentDetailModal('${s.__backendId}')" class="px-3 py-1 text-sm border rounded-lg">Detail</button><button onclick="exportStudentInRange('${s.__backendId}')" class="px-3 py-1 text-sm bg-gray-100 rounded-lg">Ekspor</button><button onclick="editStudent('${s.__backendId}')" class="px-3 py-1 text-sm text-blue-600 rounded-lg">Edit</button><button onclick="deleteStudent('${s.__backendId}')" class="px-3 py-1 text-sm text-red-600 rounded-lg">Hapus</button></div></td></tr>`;
        }).join('');
        const html = `<div class="bg-white rounded-xl card-shadow p-6 mt-4"><h3 class="font-semibold text-gray-800 mb-4">Daftar Siswa Kelas ${className}</h3><div class="overflow-x-auto"><table class="w-full text-sm"><thead class="bg-gray-50"><tr><th class="px-4 py-2 text-left">No</th><th class="px-4 py-2 text-left">Nama Lengkap</th><th class="px-4 py-2 text-left">NIS</th><th class="px-4 py-2 text-left">Hadir</th><th class="px-4 py-2 text-left">Izin</th><th class="px-4 py-2 text-left">Sakit</th><th class="px-4 py-2 text-left">Alpha</th><th class="px-4 py-2 text-left">Rata-rata Nilai</th><th class="px-4 py-2 text-left">Aksi</th></tr></thead><tbody class="divide-y">${rows}</tbody></table></div></div>`;
        const container = app.querySelector('.animate-fade'); if (container) container.insertAdjacentHTML('beforeend', html);
      })();
      const dateInput = document.getElementById('homeroomDateInput'); if (dateInput) dateInput.value = homeroomDashboardDate;
      const periodSelect = document.getElementById('homeroomPeriodSelect'); if (periodSelect) periodSelect.value = homeroomDashboardPeriod;
    }

    function renderStudentDashboard() {
      const student = getStudents().find(s => s.__backendId === currentUser.id);
      const className = student?.class_name || currentUser.class_name;
      const studentId = student?.__backendId || currentUser.id;
      const attendance = getAttendance().filter(a => a.student_id === studentId);
      const grades = getGrades().filter(g => g.student_id === studentId);

      const period = studentDashboardPeriod || 'week';
      const selectedDate = new Date(studentDashboardDate || new Date().toISOString().split('T')[0]);

      // helper to get range
      function getRange(period, dateObj) {
        const d = new Date(dateObj);
        d.setHours(0,0,0,0);
        if (period === 'day') {
          return { start: new Date(d), end: new Date(d) };
        } else if (period === 'week') {
          const day = d.getDay(); // 0 (Sun) - 6
          const diffToMonday = (day + 6) % 7; // Monday as start
          const start = new Date(d);
          start.setDate(d.getDate() - diffToMonday);
          start.setHours(0,0,0,0);
          const end = new Date(start);
          end.setDate(start.getDate() + 6);
          end.setHours(23,59,59,999);
          return { start, end };
        } else { // month
          const start = new Date(d.getFullYear(), d.getMonth(), 1);
          const end = new Date(d.getFullYear(), d.getMonth() + 1, 0, 23,59,59,999);
          return { start, end };
        }
      }

      function inRange(itemDateStr, start, end) {
        if (!itemDateStr) return false;
        const d = new Date(itemDateStr);
        return d >= start && d <= end;
      }

      const range = getRange(period, selectedDate);
      const attendanceInRange = attendance.filter(a => inRange(a.date || a.created_at || a.created_at, range.start, range.end));

      // summary totals for selected period (Hadir/Izin/Sakit/Alpha)
      const totalHadir = attendanceInRange.filter(a => a.status === 'hadir').length;
      const totalIzin = attendanceInRange.filter(a => a.status === 'izin').length;
      const totalSakit = attendanceInRange.filter(a => a.status === 'sakit').length;
      const totalAlpha = attendanceInRange.filter(a => a.status === 'alpha').length;

      // helper to get all dates in range for per-day recap
      function datesBetween(start, end) {
        const arr = [];
        const cur = new Date(start);
        cur.setHours(0,0,0,0);
        const last = new Date(end);
        last.setHours(0,0,0,0);
        while (cur <= last) { arr.push(new Date(cur)); cur.setDate(cur.getDate() + 1); }
        return arr;
      }
      const datesInRange = datesBetween(range.start, range.end);

      // get subjects from attendance and grades and SUBECTS list
      const subjectsSet = new Set();
      attendanceInRange.forEach(a => { if (a.subject) subjectsSet.add(a.subject); });
      grades.forEach(g => { if (g.subject) subjectsSet.add(g.subject); });
      SUBJECTS.forEach(s => subjectsSet.add(s));
      const subjects = Array.from(subjectsSet).sort();

      // aggregate attendance per subject
      const attendanceSummary = subjects.map(sub => {
        const list = attendanceInRange.filter(a => (a.subject || '').toLowerCase() === sub.toLowerCase());
        const total = list.length;
        const hadir = list.filter(x => x.status === 'hadir').length;
        const izin = list.filter(x => x.status === 'izin').length;
        const sakit = list.filter(x => x.status === 'sakit').length;
        const alpha = list.filter(x => x.status === 'alpha').length;
        return { subject: sub, total, hadir, izin, sakit, alpha, list };
      });

      // aggregate grades per subject: compute finalGrade per grade entry then average
      const gradesBySubject = subjects.map(sub => {
        const list = grades.filter(g => (g.subject || '').toLowerCase() === sub.toLowerCase());
        const finals = list.map(g => {
          const tasks = [g.task1, g.task2, g.task3, g.task4, g.task5].filter(t => t != null);
          const taskAvg = tasks.length > 0 ? tasks.reduce((a,b)=>a+b,0)/tasks.length : 0;
          const finalGrade = (taskAvg * 0.4) + ((g.daily_test || 0) * 0.3) + ((g.exam || 0) * 0.3);
          return { ...g, finalGrade };
        });
        const avgFinal = finals.length > 0 ? (finals.reduce((a,b)=>a+b.finalGrade,0)/finals.length) : null;
        const latest = finals.sort((a,b)=> new Date(b.date || b.created_at) - new Date(a.date || a.created_at))[0] || null;
        return { subject: sub, avgFinal, latest, list: finals };
      });

      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="h-full flex flex-col">
          <header class="gradient-bg text-white p-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <img src="logosmppas4.jpg" alt="Logo" class="w-10 h-10 rounded-full object-cover">
                <div>
                  <h1 class="text-xl font-bold">${config.school_name || defaultConfig.school_name}</h1>
                  <p class="text-sm text-white/70">${currentUser.name} - Kelas ${className}</p>
                </div>
              </div>
              <button onclick="logout()" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg flex items-center gap-2">Keluar</button>
            </div>
          </header>
          <div class="flex-1 overflow-auto p-6 bg-gray-100">
            <div class="animate-fade space-y-4">
              <div class="bg-white rounded-xl p-4 card-shadow">
                <div class="flex items-center gap-3 flex-wrap">
                  <label class="text-sm text-gray-600">Periode:</label>
                  <select id="studentPeriodSelect" class="px-3 py-2 border rounded-lg" onchange="studentDashboardPeriod = this.value; renderStudentDashboard();">
                    <option value="day" ${period==='day'?'selected':''}>Hari</option>
                    <option value="week" ${period==='week'?'selected':''}>Minggu</option>
                    <option value="month" ${period==='month'?'selected':''}>Bulan</option>
                  </select>
                  <label class="text-sm text-gray-600">Tanggal acuan:</label>
                  <input id="studentDateInput" type="date" value="${studentDashboardDate}" class="px-3 py-2 border rounded-lg" onchange="studentDashboardDate=this.value; renderStudentDashboard();">
                  <button id="studentDetailToggle" onclick="studentShowDetails = !studentShowDetails; renderStudentDashboard();" class="px-3 py-2 border rounded-lg md:hidden text-sm ml-2">
                    ${studentShowDetails ? 'Sembunyikan Rinci' : 'Tampilkan Rinci'}
                  </button>
                </div>
              </div>

              <div class="space-y-4">
                <div class="bg-white rounded-xl p-4 card-shadow flex flex-col md:flex-row items-center justify-between">
                  <div>
                    <h3 class="font-semibold text-gray-800">Ringkasan Kehadiran (${period} - ${studentDashboardDate})</h3>
                    <p class="text-sm text-gray-500">Total kehadiran dalam periode yang dipilih</p>
                  </div>
                  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 mt-4 md:mt-0 w-full md:w-auto">
                    <div class="p-3 rounded-lg bg-green-50 text-center">
                      <div class="text-sm text-gray-500">Hadir</div>
                      <div class="text-2xl font-bold text-green-700">${totalHadir}</div>
                    </div>
                    <div class="p-3 rounded-lg bg-amber-50 text-center">
                      <div class="text-sm text-gray-500">Izin</div>
                      <div class="text-2xl font-bold text-amber-700">${totalIzin}</div>
                    </div>
                    <div class="p-3 rounded-lg bg-blue-50 text-center">
                      <div class="text-sm text-gray-500">Sakit</div>
                      <div class="text-2xl font-bold text-blue-700">${totalSakit}</div>
                    </div>
                    <div class="p-3 rounded-lg bg-red-50 text-center">
                      <div class="text-sm text-gray-500">Alpha</div>
                      <div class="text-2xl font-bold text-red-700">${totalAlpha}</div>
                    </div>
                  </div>
                </div>

${(!isMobile || studentShowDetails) ? `
                <div class="bg-white rounded-xl p-4 card-shadow">
                  <h4 class="font-semibold text-gray-800 mb-2">Rekap per Tanggal</h4>
                  ${datesInRange.length === 0 ? `<p class="text-gray-500">Tidak ada data</p>` : `
                    <div class="overflow-x-auto">
                      <table class="w-full text-sm">
                        <thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left">Tanggal</th><th class="px-3 py-2 text-left">H</th><th class="px-3 py-2 text-left">I</th><th class="px-3 py-2 text-left">S</th><th class="px-3 py-2 text-left">A</th></tr></thead>
                        <tbody class="divide-y">
                          ${datesInRange.map(d => {
                            const dd = d.toISOString().split('T')[0];
                            const list = attendance.filter(a => a.date === dd);
                            const h = list.filter(x => x.status==='hadir').length;
                            const i = list.filter(x => x.status==='izin').length;
                            const s = list.filter(x => x.status==='sakit').length;
                            const a_ = list.filter(x => x.status==='alpha').length;
                            return `<tr><td class="px-3 py-2">${formatDate(dd)}</td><td class="px-3 py-2">${h}</td><td class="px-3 py-2">${i}</td><td class="px-3 py-2">${s}</td><td class="px-3 py-2">${a_}</td></tr>`;
                          }).join('')}
                        </tbody>
                      </table>
                    </div>
                  `}
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="bg-white rounded-xl p-6 card-shadow">
                    <h3 class="font-semibold text-gray-800 mb-4">Absensi per Mata Pelajaran (${period} - ${studentDashboardDate})</h3>
                    ${attendanceSummary.length === 0 ? `<p class="text-gray-500">Tidak ada data absensi pada periode ini.</p>` : `
                      <div class="space-y-3">
                        ${attendanceSummary.map(a => `
                          <div class="p-3 rounded-lg bg-gray-50">
                            <div class="flex items-center justify-between mb-2">
                              <p class="font-medium text-gray-800">${a.subject || '-'}</p>
                              <div class="text-xs text-gray-500">Total: ${a.total}</div>
                            </div>
                            <div class="grid grid-cols-4 gap-2 text-sm text-gray-600">
                              <div class="text-sm">Hadir: <strong class="text-green-600">${a.hadir}</strong></div>
                              <div class="text-sm">Izin: <strong class="text-amber-600">${a.izin}</strong></div>
                              <div class="text-sm">Sakit: <strong class="text-blue-600">${a.sakit}</strong></div>
                              <div class="text-sm">Alpha: <strong class="text-red-600">${a.alpha}</strong></div>
                            </div>
                          </div>
                        `).join('')}
                      </div>
                    `}
                  </div>

                  <div class="bg-white rounded-xl p-6 card-shadow">
                    <h3 class="font-semibold text-gray-800 mb-4">Ringkasan Nilai per Mata Pelajaran</h3>
                    ${gradesBySubject.length === 0 ? `<p class="text-gray-500">Belum ada nilai</p>` : `
                      <div class="space-y-3">
                        ${gradesBySubject.map(g => `
                          <div class="p-3 rounded-lg bg-gray-50">
                            <div class="flex items-center justify-between mb-2">
                              <p class="font-medium text-gray-800">${g.subject || '-'}</p>
                              <div class="text-sm">
                                ${g.avgFinal !== null ? `<span class="px-3 py-1 ${g.avgFinal >= 75 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} rounded-full font-bold">Rata-rata: ${g.avgFinal.toFixed(1)}</span>` : '<span class="text-gray-500">-</span>'}
                              </div>
                            </div>
                            ${g.latest ? `<div class="text-xs text-gray-500">Nilai terbaru: ${g.latest.finalGrade.toFixed(1)} (tanggal: ${g.latest.date || g.latest.created_at || '-'})</div>` : ''}
                          </div>
                        `).join('')}
                      </div>
                    `}
                  </div>
                </div>
                ` : ''}
              </div>

            </div>
          </div>
        </div>
      `;

      // ensure inputs retain values (in case function re-invoked)
      const dateInput = document.getElementById('studentDateInput'); if (dateInput) dateInput.value = studentDashboardDate;
      const periodSelect = document.getElementById('studentPeriodSelect'); if (periodSelect) periodSelect.value = studentDashboardPeriod;
      const detailToggle = document.getElementById('studentDetailToggle'); if (detailToggle) detailToggle.textContent = studentShowDetails ? 'Sembunyikan Rinci' : 'Tampilkan Rinci';
    }

    // ==================== UTILITY ====================
    function showConfirmModal(title, message, onConfirm) {
      const modal = document.createElement('div');
      modal.id = 'modal';
      modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-xl card-shadow w-full max-w-sm mx-4 animate-fade">
          <div class="p-6 text-center">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-100 flex items-center justify-center">
              <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">${title}</h3>
            <p class="text-gray-600 mb-6">${message}</p>
            <div class="flex gap-3">
              <button onclick="closeModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Batal</button>
              <button onclick="confirmAction()" class="flex-1 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg">Hapus</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      window.confirmAction = () => { closeModal(); onConfirm(); };
    }

    function closeModal() { const modal = document.getElementById('modal'); if (modal) modal.remove(); }

    // Admin purge modal: choose datasets to delete (accounts, teachers, students, homerooms, today's attendance)
    function showPurgeDataModal() {
      const accountsCount = getAccounts().length;
      const teachersCount = getTeachers().length;
      const studentsCount = getStudents().length;
      const homeroomsCount = getHomerooms().length;
      const todayStr = new Date().toISOString().split('T')[0];
      const todayAttendanceCount = getAttendance().filter(a => a.date === todayStr).length;

      const modal = document.createElement('div');
      modal.id = 'modal';
      modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-xl card-shadow w-full max-w-lg mx-4 animate-fade">
          <div class="p-6 border-b"><h3 class="text-lg font-semibold text-gray-800">Hapus Semua Data (Maintenance)</h3></div>
          <div class="p-6 space-y-4">
            <p class="text-sm text-gray-600">Pilih tipe data yang ingin dihapus. <strong class="text-red-600">Tindakan ini tidak dapat dibatalkan.</strong></p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <label class="flex items-center gap-2"><input type="checkbox" id="purgeAccounts"> <span>Akun (semua) â€” <strong>${accountsCount}</strong></span></label>
              <label class="flex items-center gap-2"><input type="checkbox" id="purgeTeachers"> <span>Data Guru â€” <strong>${teachersCount}</strong></span></label>
              <label class="flex items-center gap-2"><input type="checkbox" id="purgeStudents"> <span>Data Siswa â€” <strong>${studentsCount}</strong></span></label>
              <label class="flex items-center gap-2"><input type="checkbox" id="purgeHomerooms"> <span>Data Wali Kelas â€” <strong>${homeroomsCount}</strong></span></label>
              <label class="flex items-center gap-2"><input type="checkbox" id="purgeTodayAttendance"> <span>Absensi Hari Ini â€” <strong>${todayAttendanceCount}</strong></span></label>
            </div>

            <div>
              <label class="block text-sm text-gray-600 mb-1">Ketik <code>HAPUS</code> untuk konfirmasi</label>
              <input id="purgeConfirmInput" type="text" class="w-full px-4 py-2 border rounded-lg" placeholder="Ketik HAPUS untuk mengaktifkan tombol Hapus">
            </div>

            <div class="flex gap-3 justify-end pt-2">
              <button type="button" onclick="closeModal()" class="px-4 py-2 border border-gray-300 rounded-lg">Batal</button>
              <button id="purgeExecuteBtn" type="button" disabled class="px-4 py-2 bg-red-500 text-white rounded-lg">Hapus</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      const btn = document.getElementById('purgeExecuteBtn');
      const input = document.getElementById('purgeConfirmInput');

      function updateEnabled() {
        const anyChecked = document.getElementById('purgeAccounts').checked || document.getElementById('purgeTeachers').checked || document.getElementById('purgeStudents').checked || document.getElementById('purgeHomerooms').checked || document.getElementById('purgeTodayAttendance').checked;
        const typedOk = input.value.trim().toUpperCase() === 'HAPUS';
        btn.disabled = !(anyChecked && typedOk);
      }

      document.getElementById('purgeAccounts').addEventListener('change', updateEnabled);
      document.getElementById('purgeTeachers').addEventListener('change', updateEnabled);
      document.getElementById('purgeStudents').addEventListener('change', updateEnabled);
      document.getElementById('purgeHomerooms').addEventListener('change', updateEnabled);
      document.getElementById('purgeTodayAttendance').addEventListener('change', updateEnabled);
      input.addEventListener('input', updateEnabled);

      btn.addEventListener('click', async () => {
        const toDelete = [];
        if (document.getElementById('purgeAccounts').checked) toDelete.push(...getAccounts());
        if (document.getElementById('purgeTeachers').checked) toDelete.push(...getTeachers());
        if (document.getElementById('purgeStudents').checked) toDelete.push(...getStudents());
        if (document.getElementById('purgeHomerooms').checked) toDelete.push(...getHomerooms());
        if (document.getElementById('purgeTodayAttendance').checked) toDelete.push(...getAttendance().filter(a => a.date === todayStr));

        if (toDelete.length === 0) { showToast('Tidak ada data yang dipilih untuk dihapus', 'error'); return; }

        // final confirm with counts
        const summary = [];
        if (document.getElementById('purgeAccounts').checked) summary.push(`Akun: ${accountsCount}`);
        if (document.getElementById('purgeTeachers').checked) summary.push(`Guru: ${teachersCount}`);
        if (document.getElementById('purgeStudents').checked) summary.push(`Siswa: ${studentsCount}`);
        if (document.getElementById('purgeHomerooms').checked) summary.push(`Wali Kelas: ${homeroomsCount}`);
        if (document.getElementById('purgeTodayAttendance').checked) summary.push(`Absensi Hari Ini: ${todayAttendanceCount}`);

        showConfirmModal('Konfirmasi Hapus Semua Data', `Anda akan menghapus: ${summary.join(', ')}. Lanjutkan?`, async () => {
          try {
            // disable button and show progress
            btn.disabled = true; btn.textContent = 'Menghapus...';
            const results = await Promise.all(toDelete.map(item => window.dataSdk.delete(item).catch(err => ({ isOk: false, error: err }))));
            // refresh data and UI
            const allRes = await window.dataSdk.getAll(); if (allRes && allRes.isOk) allData = allRes.data;
            const deletedCount = results.filter(r => r && r.isOk).length;
            showToast(`Penghapusan selesai. ${deletedCount} item dihapus.`);
            closeModal();
            if (currentUser && currentUser.role === 'admin' && currentAdminView) {
              const content = document.getElementById('adminContent'); if (content) setAdminView(currentAdminView);
            }
          } catch (err) {
            console.error('Purge failed', err);
            showToast('Gagal menghapus data', 'error');
          }
        });
      });
    }

    const dataHandler = {
      onDataChanged(data) {
        allData = data;
        if (currentUser && currentUser.role === 'admin' && currentAdminView) {
          const content = document.getElementById('adminContent');
          if (content) setAdminView(currentAdminView);
        }
      }
    };

    // Data SDK: prefer IndexedDB for reliable, larger storage; fall back to localStorage if unavailable
    if (!window.dataSdk) {
      if (window.indexedDB) {
        window.dataSdk = (function(){
          const DB_NAME = 'absensi_db_v1';
          const STORE = 'items';
          const STORAGE_KEY = 'absensi_data_v1'; // legacy key for migration
          let _db = null;
          let handler = null;

          function genId() { return 'id_' + Date.now().toString(36) + Math.random().toString(36).substr(2,6); }

          function openDB() {
            return new Promise((resolve, reject) => {
              const req = indexedDB.open(DB_NAME, 1);
              req.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE, { keyPath: '__backendId' });
              };
              req.onsuccess = (e) => { _db = e.target.result; resolve(_db); };
              req.onerror = (e) => reject(e.target.error);
            });
          }

          function txPromise(storeName, mode, callback) {
            return new Promise(async (resolve, reject) => {
              try {
                const db = _db || await openDB();
                const tx = db.transaction(storeName, mode);
                const store = tx.objectStore(storeName);
                const res = await callback(store);
                tx.oncomplete = () => resolve(res);
                tx.onerror = (e) => reject(e.target.error);
              } catch (err) { reject(err); }
            });
          }

          async function getAllFromDb() {
            try {
              await openDB();
              return await txPromise(STORE, 'readonly', (store) => new Promise((res, rej) => { const r = store.getAll(); r.onsuccess = () => res(r.result || []); r.onerror = () => rej(r.error); }));
            } catch (err) { console.warn('IDB getAll failed', err); return []; }
          }

          return {
            init: async (h) => {
              handler = h;
              try {
                await openDB();
                // migrate from localStorage if DB is empty
                const existing = await getAllFromDb();
                if ((!existing || existing.length === 0) && localStorage.getItem(STORAGE_KEY)) {
                  try {
                    const ls = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                    if (ls && ls.length) {
                      for (const it of ls) {
                        // ensure we have an id
                        const obj = { ...it, __backendId: it.__backendId || genId() };
                        await txPromise(STORE, 'readwrite', (store) => new Promise((res, rej) => { const r = store.add(obj); r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error); }));
                      }
                      localStorage.removeItem(STORAGE_KEY);
                      showToast('Migrasi data ke database selesai');
                    }
                  } catch (err) { console.warn('Migration to IDB failed', err); }
                }

                const data = await getAllFromDb();
                handler?.onDataChanged(data);
                return { isOk: true };
              } catch (err) { console.error('IDB init failed', err); return { isOk: false, error: err }; }
            },
            create: async (item) => {
              try {
                const obj = { ...item, __backendId: item.__backendId || genId(), created_at: item.created_at || new Date().toISOString() };
                await txPromise(STORE, 'readwrite', (store) => new Promise((res, rej) => { const r = store.add(obj); r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error); }));
                const data = await getAllFromDb(); handler?.onDataChanged(data);
                return { isOk: true, data: obj };
              } catch (err) { console.error('IDB create failed', err); return { isOk: false, error: err }; }
            },
            update: async (item) => {
              try {
                const existing = await txPromise(STORE, 'readonly', (store) => new Promise((res, rej) => { const r = store.get(item.__backendId); r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error); }));
                if (!existing) return { isOk: false, error: 'Not found' };
                const merged = { ...existing, ...item };
                await txPromise(STORE, 'readwrite', (store) => new Promise((res, rej) => { const r = store.put(merged); r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error); }));
                const data = await getAllFromDb(); handler?.onDataChanged(data);
                return { isOk: true, data: merged };
              } catch (err) { console.error('IDB update failed', err); return { isOk: false, error: err }; }
            },
            delete: async (item) => {
              try {
                await txPromise(STORE, 'readwrite', (store) => new Promise((res, rej) => { const r = store.delete(item.__backendId); r.onsuccess = () => res(true); r.onerror = () => rej(r.error); }));
                const data = await getAllFromDb(); handler?.onDataChanged(data);
                return { isOk: true };
              } catch (err) { console.error('IDB delete failed', err); return { isOk: false, error: err }; }
            },
            getAll: async () => {
              try { const data = await getAllFromDb(); return { isOk: true, data }; } catch (err) { return { isOk: false, error: err }; }
            }
          };
        })();
      } else {
        // Fallback simple localStorage-based data SDK (used when no external dataSdk is provided)
        window.dataSdk = (function(){
          const STORAGE_KEY = 'absensi_data_v1';
          let _data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
          let handler = null;
          function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(_data)); }
          function genId() { return 'id_' + Date.now().toString(36) + Math.random().toString(36).substr(2,6); }
          return {
            init: async (h) => { handler = h; _data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); handler?.onDataChanged(_data); return { isOk: true }; },
            create: async (item) => { const obj = { ...item, __backendId: genId(), created_at: item.created_at || new Date().toISOString() }; _data.push(obj); save(); handler?.onDataChanged(_data); return { isOk: true, data: obj }; },
            update: async (item) => { const idx = _data.findIndex(d => d.__backendId === item.__backendId); if (idx === -1) return { isOk: false, error: 'Not found' }; _data[idx] = { ..._data[idx], ...item }; save(); handler?.onDataChanged(_data); return { isOk: true, data: _data[idx] }; },
            delete: async (item) => { const idx = _data.findIndex(d => d.__backendId === item.__backendId); if (idx === -1) return { isOk: false, error: 'Not found' }; _data.splice(idx, 1); save(); handler?.onDataChanged(_data); return { isOk: true }; },
            getAll: async () => ({ isOk: true, data: _data })
          };
        })();
      }
    }

    async function migrateNipToKode() {
      try {
        if (localStorage.getItem('kode_migration_done')) return;
        let tUpdated = 0, hUpdated = 0, aUpdated = 0;

        // migrate teachers
        const teachers = getTeachers();
        for (const t of teachers) {
          if ((!t.kode_guru || t.kode_guru === '') && t.nip) {
            const res = await window.dataSdk.update({ ...t, kode_guru: t.nip });
            if (res && res.isOk) tUpdated++;
          }
        }

        // migrate homerooms
        const homerooms = getHomerooms();
        for (const h of homerooms) {
          if ((!h.kode_guru || h.kode_guru === '') && h.nip) {
            const res = await window.dataSdk.update({ ...h, kode_guru: h.nip });
            if (res && res.isOk) hUpdated++;
          }
        }

        // update accounts which used old NIP as username
        const accounts = getAccounts();
        for (const a of accounts) {
          if (a.role === 'teacher' || a.role === 'homeroom') {
            const item = allData.find(d => d.__backendId === a.ref_id);
            if (!item) continue;
            const kode = item.kode_guru || item.nip;
            if (kode && a.username === item.nip && a.username !== kode) {
              const conflict = getAccounts().find(x => x.username === kode && x.__backendId !== a.__backendId);
              if (!conflict) {
                const res = await window.dataSdk.update({ ...a, username: kode });
                if (res && res.isOk) aUpdated++;
              }
            }
          }
        }

        localStorage.setItem('kode_migration_done', new Date().toISOString());
        if (tUpdated || hUpdated || aUpdated) showToast(`Migrasi selesai: guru ${tUpdated}, wali ${hUpdated}, akun ${aUpdated}`);
      } catch (err) {
        console.error('Migration failed', err);
        showToast('Gagal melakukan migrasi kode guru', 'error');
      }
    }

    async function init() {
      const result = await window.dataSdk.init(dataHandler);
      if (!result.isOk) console.error('Failed to initialize data SDK');
      // run migration once (idempotent)
      await migrateNipToKode();

      // restore persisted session (if any)
      try {
        const stored = localStorage.getItem('absensi_current_user');
        if (stored) {
          const u = JSON.parse(stored);
          if (u && u.role) currentUser = u;
        }
        const savedAdminView = localStorage.getItem('absensi_admin_view');
        if (savedAdminView) currentAdminView = savedAdminView;
      } catch (err) { console.warn('Failed to restore session', err); }

      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (cfg) => {
            config = cfg;
            const schoolTitle = document.getElementById('school-title');
            if (schoolTitle) schoolTitle.textContent = config.school_name || defaultConfig.school_name;
          },
          mapToCapabilities: (cfg) => ({ recolorables: [], borderables: [], fontEditable: undefined, fontSizeable: undefined }),
          mapToEditPanelValues: (cfg) => new Map([
            ['school_name', cfg.school_name || defaultConfig.school_name],
            ['assignedTeacherCanEdit', cfg.permissions?.assignedTeacherCanEdit || defaultConfig.permissions.assignedTeacherCanEdit],
            ['assignedTeacherCanDelete', cfg.permissions?.assignedTeacherCanDelete || defaultConfig.permissions.assignedTeacherCanDelete]
          ])
        });
        // start with elementSdk config if available, otherwise defaultConfig
        config = window.elementSdk.config || defaultConfig;
        // allow admin-overrides stored locally (persisted settings)
        try {
          const savedCfg = localStorage.getItem('absensi_config');
          if (savedCfg) {
            const parsed = JSON.parse(savedCfg);
            if (parsed) {
              config = { ...config, ...parsed };
              config.permissions = { ...(config.permissions || {}), ...(parsed.permissions || {}) };
            }
          }
        } catch (e) { console.warn('Failed to load saved config', e); }
      }
      render();

      // Register service worker for PWA (if available)
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js').then(reg => console.log('Service Worker registered', reg)).catch(err => console.warn('Service Worker registration failed', err));
      }

      // PWA install prompt handling
      let deferredPwaPrompt = null;
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPwaPrompt = e;
        showInstallButton();
      });

      function showInstallButton() {
        let btn = document.getElementById('pwaInstallBtn');
        if (!btn) {
          btn = document.createElement('button');
          btn.id = 'pwaInstallBtn';
          btn.className = 'fixed bottom-6 right-6 bg-amber-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
          btn.textContent = 'Install App';
          btn.addEventListener('click', async () => {
            if (!deferredPwaPrompt) return;
            deferredPwaPrompt.prompt();
            const choice = await deferredPwaPrompt.userChoice;
            if (choice && choice.outcome === 'accepted') showToast('Aplikasi terpasang!');
            deferredPwaPrompt = null;
            btn.remove();
          });
          document.body.appendChild(btn);
        }
        btn.style.display = deferredPwaPrompt ? 'block' : 'none';
      }

    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b3a7b6e0664b5c9',t:'MTc2NjY4ODE4Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
